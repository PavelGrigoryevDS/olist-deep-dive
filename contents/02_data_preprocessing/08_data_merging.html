
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Data Merging &#8212; ðŸŒŠ Deep Sales Analysis of Olist Marketplace</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=aa5847ba" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/custom.js?v=f9582d1e"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'contents/02_data_preprocessing/08_data_merging';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Intermediate Conclusion" href="09_intermediate_conclusion.html" />
    <link rel="prev" title="Converting Data to a Convenient Format" href="07_converting_data_to_a_convenient_format.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo-light.png" class="logo__image only-light" alt="ðŸŒŠ Deep Sales Analysis of Olist Marketplace - Home"/>
    <script>document.write(`<img src="../../_static/logo-dark.png" class="logo__image only-dark" alt="ðŸŒŠ Deep Sales Analysis of Olist Marketplace - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    ðŸŒŠ Deep Sales Analysis of Olist
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Description and Exploration</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_data_description_and_exploration/01_data_description.html">Data Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_data_description_and_exploration/02_data_loading.html">Data Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_data_description_and_exploration/03_data_exploration.html">Data Exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_data_description_and_exploration/04_intermediate_conclusion.html">Intermediate Conclusion</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Preprocessing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_initial_data_filtering.html">Initial Data Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_outlier_handling.html">Outlier Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_missing_value_handling.html">Missing Value Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_duplicate_handling.html">Duplicate Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_creating_new_metrics.html">Creating New Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_creating_new_dimensions.html">Creating New Dimensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_converting_data_to_a_convenient_format.html">Converting Data to a Convenient Format</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Data Merging</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_intermediate_conclusion.html">Intermediate Conclusion</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/01_creating_analysis_class.html">Creating Analysis Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/02_time_series_analysis.html">Time Series Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/03_customer_analysis.html">Customer Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/04_seller_analysis.html">Seller Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/05_sales_analysis.html">Sales Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/06_product_analysis.html">Product Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/07_review_analysis.html">Review Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/08_delivery_analysis.html">Delivery Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/09_payment_analysis.html">Payment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/10_geographical_analysis.html">Geographical Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/11_cohort_analysis.html">Cohort Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/12_correlation_analysis.html">Correlation Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/13_slice_analysis.html">Slice Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/14_analysis_of_customer_segments.html">Analysis of Customer Segments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/15_rfm_analysis.html">RFM Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/16_customer_clustering.html">Customer Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_data_analysis/17_hypothesis_testing.html">Hypothesis Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">General Conclusion</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/01_time_dynamics.html">Time Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/02_customers.html">Customers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/03_sales.html">Sales</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/04_products.html">Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/05_reviews.html">Reviews</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/06_delivery.html">Delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/07_payments.html">Payments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/08_sellers.html">Sellers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/09_cohort_analysis.html">Cohort Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/10_correlation_analysis.html">Correlation Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/11_black_friday.html">Black Friday</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/12_cancelled_orders.html">Cancelled Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/13_hypothesis_testing_results.html">Hypothesis Testing Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_general_conclusion/14_detected_anomalies.html">Detected Anomalies</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Recommendations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/01_product_market_fit.html">Product market fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/02_customer_loyalty_enhancement.html">Customer loyalty Enhancement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/03_customer_experience_improvement.html">Customer Experience Improvement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/04_logistics_and_delivery_optimization.html">Logistics and Delivery Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/05_financial_optimization.html">Financial optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/06_average_order_value_and_basket_optimization.html">Average Order Value and Basket Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/07_segment_specific_strategies.html">Segment-Specific Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/08_product_and_assortment_management.html">Product and Assortment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/09_marketing_and_promotion.html">Marketing and Promotion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/10_peak_season_preparedness.html">Peak Season Preparedness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/11_analytics_and_monitoring.html">Analytics and Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/12_ab_testing.html">A/B Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_recommendations/13_anomaly.html">Anomaly</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/PavelGrigoryevDS/olist-deep-dive" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/contents/02_data_preprocessing/08_data_merging.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Data Merging</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> On this page </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-items">Enriching Table df_items</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-orders">Enriching Table df_orders</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-payments">From Table  df_payments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-tables-df-items-and-df-products">From Tables df_items and df_products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-customers">From Table  df_customers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-reviews">From Table  df_reviews</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-new-dimensions">Creating New Dimensions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-table-df-sales">Creating Table df_sales</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-customers">Enriching Table df_customers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-orders">From Table  df_orders</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-sales">From Table  df_sales</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-geolocations">From Table  df_geolocations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#customer-segmentation">Customer Segmentation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-products">Enriching Table df_products</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">From Table  df_orders</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">From Table  df_sales</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-sellers">Enriching Table df_sellers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">From Tables df_items and df_products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">From Table  df_geolocations</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="data-merging">
<h1>Data Merging<a class="headerlink" href="#data-merging" title="Link to this heading">#</a></h1>
<section id="enriching-table-df-items">
<h2>Enriching Table df_items<a class="headerlink" href="#enriching-table-df-items" title="Link to this heading">#</a></h2>
<p><strong>Buyer-Seller Distance</strong></p>
<p>Create a distance variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_customers</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;customer_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">tmp_df_customers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;geolocation_lat&#39;</span><span class="p">:</span> <span class="s1">&#39;lat_customer&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_lng&#39;</span><span class="p">:</span> <span class="s1">&#39;lng_customer&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tmp_df_customers</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_zip_code_prefix_3_digits&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sellers</span> <span class="o">=</span> <span class="n">df_sellers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;seller_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">tmp_df_sellers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;geolocation_lat&#39;</span><span class="p">:</span> <span class="s1">&#39;lat_seller&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_lng&#39;</span><span class="p">:</span> <span class="s1">&#39;lng_seller&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tmp_df_sellers</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_zip_code_prefix_3_digits&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_orders</span><span class="p">[[</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_id&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_customers</span><span class="p">[[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_customer&#39;</span><span class="p">,</span> <span class="s1">&#39;lng_customer&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_sellers</span><span class="p">[[</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_seller&#39;</span><span class="p">,</span> <span class="s1">&#39;lng_seller&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate buyer-seller distances.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fron</span><span class="o">.</span><span class="n">haversine_vectorized</span><span class="p">(</span>
    <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;lat_customer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;lng_customer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;lat_seller&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;lng_seller&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_customer&#39;</span><span class="p">,</span> <span class="s1">&#39;lng_customer&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_seller&#39;</span><span class="p">,</span> <span class="s1">&#39;lng_seller&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check for missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span><span class="o">.</span><span class="n">distance_km</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.int64(554)
</pre></div>
</div>
</div>
</div>
<p>Missing values occur when zip prefixes are absent from the geolocation table for some buyers/sellers.</p>
<p>The quantity is small - leave as is.</p>
<p><strong>Carrier Handoff Delay</strong></p>
<p>Create a carrier handoff delay variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span> <span class="o">=</span> <span class="n">df_items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_orders</span><span class="p">[[</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_delivered_carrier_dt&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;carrier_delivery_delay_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;order_delivered_carrier_dt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;shipping_limit_dt&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Convert to daysâ€¦</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;carrier_delivery_delay_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_items</span><span class="p">[</span><span class="s1">&#39;carrier_delivery_delay_days&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;order_delivered_carrier_dt&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="enriching-table-df-orders">
<h2>Enriching Table df_orders<a class="headerlink" href="#enriching-table-df-orders" title="Link to this heading">#</a></h2>
<section id="from-table-df-payments">
<h3>From Table  df_payments<a class="headerlink" href="#from-table-df-payments" title="Link to this heading">#</a></h3>
<p>Create these order-level metrics:</p>
<ul class="simple">
<li><p>Payment count</p></li>
<li><p>Payment sum</p></li>
<li><p>Average payment</p></li>
<li><p>Total installment count</p></li>
</ul>
<p>Create these order-level dimensions:</p>
<ul class="simple">
<li><p>Installment presence</p></li>
<li><p>Payment types</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_pay_agg</span> <span class="o">=</span> <span class="n">df_payments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp_df_pay_agg</span><span class="p">[</span><span class="s1">&#39;has_installments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_pay_agg</span><span class="p">[</span><span class="s1">&#39;has_installments&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Has Installments&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Examine unique payment types per order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_pay_agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">)[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>payment_type
1    96851
2     2241
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Since maximum is 2 payment types, concatenate them during aggregation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_pay_agg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tmp_df_pay_agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">payments_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payment_sequential&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">total_payment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payment_value&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_payment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payment_value&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">total_installments_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payment_installments&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">order_has_installment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;has_installments&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">order_payment_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payment_type&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_pay_agg</span><span class="p">[</span><span class="s1">&#39;order_payment_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_pay_agg</span><span class="p">[</span><span class="s1">&#39;order_payment_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_pay_agg</span><span class="p">[</span><span class="s1">&#39;order_has_installment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_pay_agg</span><span class="o">.</span><span class="n">order_has_installment</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;Has Installments&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;No Installments&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Merge with df_orders.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_orders</span><span class="p">,</span> <span class="n">tmp_df_pay_agg</span><span class="p">,</span> <span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_a614a caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_a614a th {
  text-align: left;
}
#T_a614a_row0_col0, #T_a614a_row0_col1, #T_a614a_row0_col2, #T_a614a_row0_col3, #T_a614a_row0_col4, #T_a614a_row0_col5 {
  text-align: left;
}
</style>
<table id="T_a614a">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_a614a_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_a614a_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_a614a_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_a614a_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_a614a_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_a614a_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_a614a_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_a614a_row0_col1" class="data row0 col1" >0</td>
      <td id="T_a614a_row0_col2" class="data row0 col2" >0</td>
      <td id="T_a614a_row0_col3" class="data row0 col3" >99,092</td>
      <td id="T_a614a_row0_col4" class="data row0 col4" >99,092</td>
      <td id="T_a614a_row0_col5" class="data row0 col5" >99,092</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_pay_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-tables-df-items-and-df-products">
<h3>From Tables df_items and df_products<a class="headerlink" href="#from-tables-df-items-and-df-products" title="Link to this heading">#</a></h3>
<p>Create these order-level metrics:</p>
<ul class="simple">
<li><p>Total product count</p></li>
<li><p>Unique product count</p></li>
<li><p>Seller count</p></li>
<li><p>Unique category count</p></li>
<li><p>Total product price</p></li>
<li><p>Average product price</p></li>
<li><p>Total shipping cost</p></li>
<li><p>Total order value</p></li>
<li><p>Shipping cost ratio</p></li>
<li><p>Order weight</p></li>
<li><p>Order volume</p></li>
<li><p>Average buyer-seller distance</p></li>
<li><p>Average carrier handoff delay</p></li>
</ul>
<p>Create these order-level dimensions:</p>
<ul class="simple">
<li><p>Free shipping indicator</p></li>
<li><p>Generalized product categories</p></li>
</ul>
<p>First merge items and products tables.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">df_products</span><span class="p">,</span> <span class="s2">&quot;product_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_ef8fa caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_ef8fa th {
  text-align: left;
}
#T_ef8fa_row0_col0, #T_ef8fa_row0_col1, #T_ef8fa_row0_col2, #T_ef8fa_row0_col3, #T_ef8fa_row0_col4, #T_ef8fa_row0_col5 {
  text-align: left;
}
</style>
<table id="T_ef8fa">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_ef8fa_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_ef8fa_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_ef8fa_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_ef8fa_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_ef8fa_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_ef8fa_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_ef8fa_row0_col0" class="data row0 col0" >N:1</td>
      <td id="T_ef8fa_row0_col1" class="data row0 col1" >0</td>
      <td id="T_ef8fa_row0_col2" class="data row0 col2" >164</td>
      <td id="T_ef8fa_row0_col3" class="data row0 col3" >112,279</td>
      <td id="T_ef8fa_row0_col4" class="data row0 col4" >32,951</td>
      <td id="T_ef8fa_row0_col5" class="data row0 col5" >112,279</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods</span> <span class="o">=</span> <span class="n">df_items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_products</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Prepare dataframe.</p>
<p>Examine unique categories per order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">)[</span><span class="s1">&#39;product_category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>product_category
1    97570
2      765
3       18
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Maximum 3 categories - concatenate during aggregation.</p>
<p>Examine unique generalized categories per order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">)[</span><span class="s1">&#39;general_product_category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>general_product_category
1    97777
2      567
3        9
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Maximum 3 categories - concatenate during aggregation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_df_items_prods</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
          <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
              <span class="n">products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">unique_products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">sellers_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">product_categories_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_category&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">total_products_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">avg_products_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">total_freight_value</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;freight_value&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">total_order_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">total_weight_kg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_weight_g&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">total_volume_cm3</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_volume_cm3&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">avg_distance_km</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;distance_km&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">avg_carrier_delivery_delay_days</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;carrier_delivery_delay_days&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">order_product_categories</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_category&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
              <span class="p">,</span> <span class="n">order_general_product_categories</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;general_product_category&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
          <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;freight_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;total_freight_value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;total_order_price&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_general_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_general_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;total_weight_kg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;total_weight_kg&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg</span><span class="o">.</span><span class="n">total_freight_value</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg</span><span class="o">.</span><span class="n">order_is_free_shipping</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;Free Shipping&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;Paid Shipping&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>order_is_free_shipping
Paid Shipping    98015
Free Shipping      338
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Add new fields to df_orders.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_orders</span><span class="p">,</span> <span class="n">tmp_df_items_prods_agg</span><span class="p">,</span> <span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_8dfe0 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_8dfe0 th {
  text-align: left;
}
#T_8dfe0_row0_col0, #T_8dfe0_row0_col1, #T_8dfe0_row0_col2, #T_8dfe0_row0_col3, #T_8dfe0_row0_col4, #T_8dfe0_row0_col5 {
  text-align: left;
}
</style>
<table id="T_8dfe0">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_8dfe0_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_8dfe0_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_8dfe0_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_8dfe0_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_8dfe0_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_8dfe0_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_8dfe0_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_8dfe0_row0_col1" class="data row0 col1" >739</td>
      <td id="T_8dfe0_row0_col2" class="data row0 col2" >0</td>
      <td id="T_8dfe0_row0_col3" class="data row0 col3" >99,092</td>
      <td id="T_8dfe0_row0_col4" class="data row0 col4" >98,353</td>
      <td id="T_8dfe0_row0_col5" class="data row0 col5" >99,092</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We previously identified orders in df_orders missing from df_items.</p>
<p>These are all either canceled or unavailable - missing values from items table are expected.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_items_prods_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-table-df-customers">
<h3>From Table  df_customers<a class="headerlink" href="#from-table-df-customers" title="Link to this heading">#</a></h3>
<p>Add customer city and state.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_orders</span><span class="p">,</span> <span class="n">df_customers</span><span class="p">,</span> <span class="s2">&quot;customer_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_aeeb8 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_aeeb8 th {
  text-align: left;
}
#T_aeeb8_row0_col0, #T_aeeb8_row0_col1, #T_aeeb8_row0_col2, #T_aeeb8_row0_col3, #T_aeeb8_row0_col4, #T_aeeb8_row0_col5 {
  text-align: left;
}
</style>
<table id="T_aeeb8">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_aeeb8_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_aeeb8_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_aeeb8_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_aeeb8_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_aeeb8_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_aeeb8_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_aeeb8_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_aeeb8_row0_col1" class="data row0 col1" >0</td>
      <td id="T_aeeb8_row0_col2" class="data row0 col2" >0</td>
      <td id="T_aeeb8_row0_col3" class="data row0 col3" >99,092</td>
      <td id="T_aeeb8_row0_col4" class="data row0 col4" >99,092</td>
      <td id="T_aeeb8_row0_col5" class="data row0 col5" >99,092</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Add fields to df_orders.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_customers</span><span class="p">[[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_state&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_city&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-table-df-reviews">
<h3>From Table  df_reviews<a class="headerlink" href="#from-table-df-reviews" title="Link to this heading">#</a></h3>
<p>Create these order-level metrics:</p>
<ul class="simple">
<li><p>Review count</p></li>
<li><p>Average review score</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_reviews_agg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_reviews</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">reviews_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;review_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">order_avg_reviews_score</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;review_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since secondary reviews tend to be lower-scored, round down.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_reviews_agg</span><span class="p">[</span><span class="s1">&#39;order_avg_reviews_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">tmp_df_reviews_agg</span><span class="p">[</span><span class="s1">&#39;order_avg_reviews_score&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_orders</span><span class="p">,</span> <span class="n">tmp_df_reviews_agg</span><span class="p">,</span> <span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_14a5a caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_14a5a th {
  text-align: left;
}
#T_14a5a_row0_col0, #T_14a5a_row0_col1, #T_14a5a_row0_col2, #T_14a5a_row0_col3, #T_14a5a_row0_col4, #T_14a5a_row0_col5 {
  text-align: left;
}
</style>
<table id="T_14a5a">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_14a5a_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_14a5a_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_14a5a_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_14a5a_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_14a5a_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_14a5a_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_14a5a_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_14a5a_row0_col1" class="data row0 col1" >0</td>
      <td id="T_14a5a_row0_col2" class="data row0 col2" >0</td>
      <td id="T_14a5a_row0_col3" class="data row0 col3" >99,092</td>
      <td id="T_14a5a_row0_col4" class="data row0 col4" >99,092</td>
      <td id="T_14a5a_row0_col5" class="data row0 col5" >99,092</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Add fields to df_orders.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_reviews_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-new-dimensions">
<h3>Creating New Dimensions<a class="headerlink" href="#creating-new-dimensions" title="Link to this heading">#</a></h3>
<p><strong>Create a new payment amount dimension</strong></p>
<p>Letâ€™s look at the quantiles in the column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">total_payment</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.05    32.38
0.25    62.00
0.50   105.28
0.75   176.87
0.95   452.28
Name: total_payment, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Create the following categories:</p>
<ul class="simple">
<li><p>Cheap: â‰¤50 R$</p></li>
<li><p>Medium: 50-200 R$</p></li>
<li><p>Expensive: &gt;200 R$</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cheap&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span> <span class="s1">&#39;Expensive&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_total_payment_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">total_payment</span><span class="o">.</span><span class="n">preproc</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Medium</th>
      <td>61993</td>
    </tr>
    <tr>
      <th>Expensive</th>
      <td>20189</td>
    </tr>
    <tr>
      <th>Cheap</th>
      <td>16910</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Create a new order weight dimension</strong></p>
<p>Letâ€™s look at the quantiles in the column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">total_weight_kg</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.05    0.14
0.25    0.30
0.50    0.75
0.75    2.05
0.95   10.59
Name: total_weight_kg, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Categories for order weight:</p>
<ul class="simple">
<li><p>Light: â‰¤500g</p></li>
<li><p>Medium: 500-5000g</p></li>
<li><p>Heavy: &gt;5kg</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span> <span class="s1">&#39;Heavy&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_total_weight_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_orders</span><span class="o">.</span><span class="n">total_weight_kg</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Missing in Items&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Medium</th>
      <td>45450</td>
    </tr>
    <tr>
      <th>Light</th>
      <td>39654</td>
    </tr>
    <tr>
      <th>Heavy</th>
      <td>13249</td>
    </tr>
    <tr>
      <th>Missing in Items</th>
      <td>739</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Create a new order volume dimension</strong></p>
<p>Letâ€™s look at the quantiles in the column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">total_volume_cm3</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.05      816.00
0.25    2,964.00
0.50    7,260.00
0.75   19,872.00
0.95   64,000.00
Name: total_volume_cm3, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Categories for order volume:</p>
<ul class="simple">
<li><p>Small: â‰¤3500 cm3</p></li>
<li><p>Medium: 3500-10000 cm3</p></li>
<li><p>Large: &gt;10000 cm3</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Small&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span> <span class="s1">&#39;Large&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">3500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_total_volume_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_orders</span><span class="o">.</span><span class="n">total_volume_cm3</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Missing in Items&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Large</th>
      <td>39869</td>
    </tr>
    <tr>
      <th>Medium</th>
      <td>29455</td>
    </tr>
    <tr>
      <th>Small</th>
      <td>29029</td>
    </tr>
    <tr>
      <th>Missing in Items</th>
      <td>739</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Create a new review score dimension</strong></p>
<p>Categories:</p>
<ul class="simple">
<li><p>Positive: 4-5</p></li>
<li><p>Neutral: 3</p></li>
<li><p>Negative: 1-2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Positive&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
    <span class="s2">&quot;Neutral&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;Negative&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="s2">&quot;Missing Score&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
<span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_review_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">order_avg_reviews_score</span><span class="o">.</span><span class="n">preproc</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">rules</span><span class="o">=</span><span class="n">rules</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Positive</th>
      <td>75966</td>
    </tr>
    <tr>
      <th>Negative</th>
      <td>14882</td>
    </tr>
    <tr>
      <th>Neutral</th>
      <td>8244</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Letâ€™s look at the missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">explore</span><span class="o">.</span><span class="n">detect_anomalies</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_65190 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_65190 th {
  text-align: left;
}
#T_65190_row0_col0, #T_65190_row0_col1, #T_65190_row1_col0, #T_65190_row1_col1, #T_65190_row2_col0, #T_65190_row2_col1, #T_65190_row3_col0, #T_65190_row3_col1, #T_65190_row4_col0, #T_65190_row4_col1, #T_65190_row5_col0, #T_65190_row5_col1, #T_65190_row6_col0, #T_65190_row6_col1, #T_65190_row7_col0, #T_65190_row7_col1, #T_65190_row8_col0, #T_65190_row8_col1, #T_65190_row9_col0, #T_65190_row9_col1, #T_65190_row10_col0, #T_65190_row10_col1, #T_65190_row11_col0, #T_65190_row11_col1, #T_65190_row12_col0, #T_65190_row12_col1, #T_65190_row13_col0, #T_65190_row13_col1, #T_65190_row14_col0, #T_65190_row14_col1, #T_65190_row15_col0, #T_65190_row15_col1, #T_65190_row16_col0, #T_65190_row16_col1, #T_65190_row17_col0, #T_65190_row17_col1, #T_65190_row18_col0, #T_65190_row18_col1, #T_65190_row19_col0, #T_65190_row19_col1, #T_65190_row20_col0, #T_65190_row20_col1, #T_65190_row21_col0, #T_65190_row21_col1, #T_65190_row22_col0, #T_65190_row22_col1, #T_65190_row23_col0, #T_65190_row23_col1, #T_65190_row24_col0, #T_65190_row24_col1, #T_65190_row25_col0, #T_65190_row25_col1 {
  text-align: left;
}
</style>
<table id="T_65190">
  <caption>Missings by Column</caption>
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_65190_level0_col0" class="col_heading level0 col0" >Count</th>
      <th id="T_65190_level0_col1" class="col_heading level0 col1" >Percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_65190_level0_row0" class="row_heading level0 row0" >order_approved_dt</th>
      <td id="T_65190_row0_col0" class="data row0 col0" >121</td>
      <td id="T_65190_row0_col1" class="data row0 col1" >0.12%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row1" class="row_heading level0 row1" >order_delivered_carrier_dt</th>
      <td id="T_65190_row1_col0" class="data row1 col0" >1714</td>
      <td id="T_65190_row1_col1" class="data row1 col1" >1.73%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row2" class="row_heading level0 row2" >order_delivered_customer_dt</th>
      <td id="T_65190_row2_col0" class="data row2 col0" >2880</td>
      <td id="T_65190_row2_col1" class="data row2 col1" >2.91%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row3" class="row_heading level0 row3" >from_purchase_to_approved_hours</th>
      <td id="T_65190_row3_col0" class="data row3 col0" >121</td>
      <td id="T_65190_row3_col1" class="data row3 col1" >0.12%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row4" class="row_heading level0 row4" >from_purchase_to_carrier_days</th>
      <td id="T_65190_row4_col0" class="data row4 col0" >1714</td>
      <td id="T_65190_row4_col1" class="data row4 col1" >1.73%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row5" class="row_heading level0 row5" >delivery_time_days</th>
      <td id="T_65190_row5_col0" class="data row5 col0" >2880</td>
      <td id="T_65190_row5_col1" class="data row5 col1" >2.91%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row6" class="row_heading level0 row6" >delivery_delay_days</th>
      <td id="T_65190_row6_col0" class="data row6 col0" >2880</td>
      <td id="T_65190_row6_col1" class="data row6 col1" >2.91%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row7" class="row_heading level0 row7" >from_approved_to_carrier_days</th>
      <td id="T_65190_row7_col0" class="data row7 col0" >1714</td>
      <td id="T_65190_row7_col1" class="data row7 col1" >1.73%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row8" class="row_heading level0 row8" >from_carrier_to_customer_days</th>
      <td id="T_65190_row8_col0" class="data row8 col0" >2880</td>
      <td id="T_65190_row8_col1" class="data row8 col1" >2.91%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row9" class="row_heading level0 row9" >delivery_time_days_cat</th>
      <td id="T_65190_row9_col0" class="data row9 col0" >2880</td>
      <td id="T_65190_row9_col1" class="data row9 col1" >2.91%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row10" class="row_heading level0 row10" >products_cnt</th>
      <td id="T_65190_row10_col0" class="data row10 col0" >739</td>
      <td id="T_65190_row10_col1" class="data row10 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row11" class="row_heading level0 row11" >unique_products_cnt</th>
      <td id="T_65190_row11_col0" class="data row11 col0" >739</td>
      <td id="T_65190_row11_col1" class="data row11 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row12" class="row_heading level0 row12" >sellers_cnt</th>
      <td id="T_65190_row12_col0" class="data row12 col0" >739</td>
      <td id="T_65190_row12_col1" class="data row12 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row13" class="row_heading level0 row13" >product_categories_cnt</th>
      <td id="T_65190_row13_col0" class="data row13 col0" >739</td>
      <td id="T_65190_row13_col1" class="data row13 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row14" class="row_heading level0 row14" >total_products_price</th>
      <td id="T_65190_row14_col0" class="data row14 col0" >739</td>
      <td id="T_65190_row14_col1" class="data row14 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row15" class="row_heading level0 row15" >avg_products_price</th>
      <td id="T_65190_row15_col0" class="data row15 col0" >739</td>
      <td id="T_65190_row15_col1" class="data row15 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row16" class="row_heading level0 row16" >total_freight_value</th>
      <td id="T_65190_row16_col0" class="data row16 col0" >739</td>
      <td id="T_65190_row16_col1" class="data row16 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row17" class="row_heading level0 row17" >total_order_price</th>
      <td id="T_65190_row17_col0" class="data row17 col0" >739</td>
      <td id="T_65190_row17_col1" class="data row17 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row18" class="row_heading level0 row18" >total_weight_kg</th>
      <td id="T_65190_row18_col0" class="data row18 col0" >739</td>
      <td id="T_65190_row18_col1" class="data row18 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row19" class="row_heading level0 row19" >total_volume_cm3</th>
      <td id="T_65190_row19_col0" class="data row19 col0" >739</td>
      <td id="T_65190_row19_col1" class="data row19 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row20" class="row_heading level0 row20" >avg_distance_km</th>
      <td id="T_65190_row20_col0" class="data row20 col0" >1228</td>
      <td id="T_65190_row20_col1" class="data row20 col1" >1.24%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row21" class="row_heading level0 row21" >avg_carrier_delivery_delay_days</th>
      <td id="T_65190_row21_col0" class="data row21 col0" >1714</td>
      <td id="T_65190_row21_col1" class="data row21 col1" >1.73%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row22" class="row_heading level0 row22" >order_product_categories</th>
      <td id="T_65190_row22_col0" class="data row22 col0" >739</td>
      <td id="T_65190_row22_col1" class="data row22 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row23" class="row_heading level0 row23" >order_general_product_categories</th>
      <td id="T_65190_row23_col0" class="data row23 col0" >739</td>
      <td id="T_65190_row23_col1" class="data row23 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row24" class="row_heading level0 row24" >freight_ratio</th>
      <td id="T_65190_row24_col0" class="data row24 col0" >739</td>
      <td id="T_65190_row24_col1" class="data row24 col1" >0.75%</td>
    </tr>
    <tr>
      <th id="T_65190_level0_row25" class="row_heading level0 row25" >order_is_free_shipping</th>
      <td id="T_65190_row25_col0" class="data row25 col0" >739</td>
      <td id="T_65190_row25_col1" class="data row25 col1" >0.75%</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<ul class="simple">
<li><p>Missing values in time-related variables occur due to absent dates (normal for undelivered orders)</p></li>
<li><p>Missing values in product-related variables occur because some orders arenâ€™t in the items table (canceled/unavailable). These wonâ€™t affect sales analysis.</p></li>
</ul>
<p>For dimensions, replace missing values with â€˜No Order In Itemsâ€™</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span>
<span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_general_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_general_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span>
<span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="creating-table-df-sales">
<h2>Creating Table df_sales<a class="headerlink" href="#creating-table-df-sales" title="Link to this heading">#</a></h2>
<p>The orders table contains order creation time, payment approval time, and order status. After examining statuses:</p>
<ul class="simple">
<li><p><strong>created</strong>: Few orders, old, comments indicate non-delivery</p></li>
<li><p><strong>approved</strong>: Few orders, old, no comments</p></li>
<li><p><strong>processing</strong>: &gt;90% have 1-2 star reviews, most undelivered (some reviews mention stockouts)</p></li>
<li><p><strong>invoiced</strong>: &gt;80% have 1-2 stars, mostly undelivered (some mention stockouts)</p></li>
<li><p><strong>shipped</strong>: &gt;70% have 1-2 stars, mostly undelivered</p></li>
</ul>
<p>Letâ€™s look at how the total delivery time is distributed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;delivery_time_estimated_days&#39;</span>
    <span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;delivery_time_estimated_days&#39;</span><span class="p">:</span> <span class="s1">&#39;Delivery time to customer, days&#39;</span><span class="p">}</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Distribution of delivery time to customer&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/20a78cac15bca9d4625c4526c1de5d96a6195480da5e577d167f83215ce7725f.jpg" src="../../_images/20a78cac15bca9d4625c4526c1de5d96a6195480da5e577d167f83215ce7725f.jpg" />
</div>
</div>
<p>Delivery typically takes â‰¤1 month. Weâ€™ll use this threshold to determine delivery status.</p>
<p>Letâ€™s look at how the statuses are distributed for orders that have passed a month from the estimated delivery date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_last_date</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">order_purchase_dt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_mask</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">tmp_last_date</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">order_estimated_delivery_dt</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">order_status</span> <span class="o">!=</span> <span class="s1">&#39;Delivered&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="p">[</span><span class="n">tmp_mask</span><span class="p">]</span><span class="o">.</span><span class="n">order_status</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>order_status
Shipped        998
Unavailable    580
Canceled       464
Processing     298
Invoiced       261
Created          5
Approved         2
Delivered        0
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p><strong>Key Observations:</strong></p>
<ul class="simple">
<li><p>Since delivery usually takes â‰¤1 month, orders exceeding this are considered undelivered (confirmed by review content mentioning non-delivery/stockouts).</p></li>
</ul>
<p>Weâ€™ll define a purchase as:</p>
<ul class="simple">
<li><p>Orders without â€˜canceledâ€™/â€˜unavailableâ€™ status</p></li>
<li><p>Orders with â€˜deliveredâ€™ status</p></li>
<li><p>Orders without â€˜deliveredâ€™ status where &lt;31 days since purchase</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">df_orders</span><span class="o">.</span><span class="n">order_status</span> <span class="o">==</span> <span class="s1">&#39;Delivered&#39;</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">(</span>
        <span class="p">((</span><span class="n">tmp_last_date</span> <span class="o">-</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">order_estimated_delivery_dt</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="o">~</span><span class="n">df_orders</span><span class="o">.</span><span class="n">order_status</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Canceled&#39;</span><span class="p">,</span> <span class="s1">&#39;Unavailable&#39;</span><span class="p">]))</span> 
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sales</span> <span class="o">=</span> <span class="n">df_orders</span><span class="p">[</span><span class="n">tmp_mask</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s look at the count by statuses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">order_status</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>order_status
Delivered      96211
Shipped         1097
Unavailable      602
Canceled         580
Processing       299
Invoiced         296
Created            5
Approved           2
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Weâ€™ll create an order-level variable indicating purchase conversion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="p">[</span><span class="s1">&#39;is_purchase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_mask</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;Purchase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;Not Purchase&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_orders</span><span class="o">.</span><span class="n">is_purchase</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>is_purchase
Purchase        96346
Not Purchase     2746
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p><strong>Create first purchase flag</strong></p>
<p>To handle multiple purchases within the same timestamp, use ranking.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sort by customer and purchase date for correct ranking</span>
<span class="n">df_sales</span> <span class="o">=</span> <span class="n">df_sales</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">])</span>

<span class="c1"># Global first purchase flag (with tie-breaking via purchase_rank)</span>
<span class="n">df_sales</span><span class="p">[</span><span class="s1">&#39;customer_first_purchase_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)[</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
<span class="n">df_sales</span><span class="p">[</span><span class="s1">&#39;purchase_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
<span class="n">df_sales</span><span class="p">[</span><span class="s1">&#39;sale_is_customer_first_purchase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">df_sales</span><span class="p">[</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_sales</span><span class="p">[</span><span class="s1">&#39;customer_first_purchase_dt&#39;</span><span class="p">])</span> 
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_sales</span><span class="p">[</span><span class="s1">&#39;purchase_rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">df_sales</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;purchase_rank&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s look at the missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sales</span><span class="o">.</span><span class="n">explore</span><span class="o">.</span><span class="n">detect_anomalies</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_0b7ab caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_0b7ab th {
  text-align: left;
}
#T_0b7ab_row0_col0, #T_0b7ab_row0_col1, #T_0b7ab_row1_col0, #T_0b7ab_row1_col1, #T_0b7ab_row2_col0, #T_0b7ab_row2_col1, #T_0b7ab_row3_col0, #T_0b7ab_row3_col1, #T_0b7ab_row4_col0, #T_0b7ab_row4_col1, #T_0b7ab_row5_col0, #T_0b7ab_row5_col1, #T_0b7ab_row6_col0, #T_0b7ab_row6_col1, #T_0b7ab_row7_col0, #T_0b7ab_row7_col1, #T_0b7ab_row8_col0, #T_0b7ab_row8_col1, #T_0b7ab_row9_col0, #T_0b7ab_row9_col1 {
  text-align: left;
}
</style>
<table id="T_0b7ab">
  <caption>Missings by Column</caption>
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_0b7ab_level0_col0" class="col_heading level0 col0" >Count</th>
      <th id="T_0b7ab_level0_col1" class="col_heading level0 col1" >Percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_0b7ab_level0_row0" class="row_heading level0 row0" >order_delivered_carrier_dt</th>
      <td id="T_0b7ab_row0_col0" class="data row0 col0" >36</td>
      <td id="T_0b7ab_row0_col1" class="data row0 col1" >0.04%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row1" class="row_heading level0 row1" >order_delivered_customer_dt</th>
      <td id="T_0b7ab_row1_col0" class="data row1 col0" >135</td>
      <td id="T_0b7ab_row1_col1" class="data row1 col1" >0.14%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row2" class="row_heading level0 row2" >from_purchase_to_carrier_days</th>
      <td id="T_0b7ab_row2_col0" class="data row2 col0" >36</td>
      <td id="T_0b7ab_row2_col1" class="data row2 col1" >0.04%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row3" class="row_heading level0 row3" >delivery_time_days</th>
      <td id="T_0b7ab_row3_col0" class="data row3 col0" >135</td>
      <td id="T_0b7ab_row3_col1" class="data row3 col1" >0.14%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row4" class="row_heading level0 row4" >delivery_delay_days</th>
      <td id="T_0b7ab_row4_col0" class="data row4 col0" >135</td>
      <td id="T_0b7ab_row4_col1" class="data row4 col1" >0.14%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row5" class="row_heading level0 row5" >from_approved_to_carrier_days</th>
      <td id="T_0b7ab_row5_col0" class="data row5 col0" >36</td>
      <td id="T_0b7ab_row5_col1" class="data row5 col1" >0.04%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row6" class="row_heading level0 row6" >from_carrier_to_customer_days</th>
      <td id="T_0b7ab_row6_col0" class="data row6 col0" >135</td>
      <td id="T_0b7ab_row6_col1" class="data row6 col1" >0.14%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row7" class="row_heading level0 row7" >delivery_time_days_cat</th>
      <td id="T_0b7ab_row7_col0" class="data row7 col0" >135</td>
      <td id="T_0b7ab_row7_col1" class="data row7 col1" >0.14%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row8" class="row_heading level0 row8" >avg_distance_km</th>
      <td id="T_0b7ab_row8_col0" class="data row8 col0" >476</td>
      <td id="T_0b7ab_row8_col1" class="data row8 col1" >0.49%</td>
    </tr>
    <tr>
      <th id="T_0b7ab_level0_row9" class="row_heading level0 row9" >avg_carrier_delivery_delay_days</th>
      <td id="T_0b7ab_row9_col0" class="data row9 col0" >36</td>
      <td id="T_0b7ab_row9_col1" class="data row9 col1" >0.04%</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Results are as expected.</p>
</section>
<section id="enriching-table-df-customers">
<h2>Enriching Table df_customers<a class="headerlink" href="#enriching-table-df-customers" title="Link to this heading">#</a></h2>
<p>customer_unique_id isnâ€™t unique in df_customers (data characteristic). For analysis, weâ€™ll:</p>
<ul class="simple">
<li><p>Save original table under new name</p></li>
<li><p>Remove duplicates from df_customers for user analysis</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers_origin</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="from-table-df-orders">
<h3>From Table  df_orders<a class="headerlink" href="#from-table-df-orders" title="Link to this heading">#</a></h3>
<p>Create metrics for each customer:</p>
<ul class="simple">
<li><p>Order count</p></li>
<li><p>Canceled order count</p></li>
<li><p>Cancelation rate</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_orders_agg</span> <span class="o">=</span> <span class="n">df_orders</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;is_canceled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;order_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Canceled&#39;</span>
<span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;is_not_delivered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;order_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Delivered&#39;</span>
<span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;is_customer_issue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;delivery_issue_reason&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Customer Issue&#39;</span>
<span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;is_service_issue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_orders_agg</span><span class="p">[</span><span class="s1">&#39;delivery_issue_reason&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Service Issue&#39;</span>
<span class="n">tmp_df_orders_agg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tmp_df_orders_agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">orders_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">canceled_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_canceled&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">canceled_orders_cnt</span><span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_canceled&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">not_delivered_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_not_delivered&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">customer_issue_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_customer_issue&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">service_issue_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_service_issue&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_orders</span><span class="p">,</span> <span class="n">tmp_df_reviews_agg</span><span class="p">,</span> <span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_42a10 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_42a10 th {
  text-align: left;
}
#T_42a10_row0_col0, #T_42a10_row0_col1, #T_42a10_row0_col2, #T_42a10_row0_col3, #T_42a10_row0_col4, #T_42a10_row0_col5 {
  text-align: left;
}
</style>
<table id="T_42a10">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_42a10_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_42a10_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_42a10_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_42a10_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_42a10_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_42a10_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_42a10_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_42a10_row0_col1" class="data row0 col1" >0</td>
      <td id="T_42a10_row0_col2" class="data row0 col2" >0</td>
      <td id="T_42a10_row0_col3" class="data row0 col3" >99,092</td>
      <td id="T_42a10_row0_col4" class="data row0 col4" >99,092</td>
      <td id="T_42a10_row0_col5" class="data row0 col5" >99,092</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_orders_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-table-df-sales">
<h3>From Table  df_sales<a class="headerlink" href="#from-table-df-sales" title="Link to this heading">#</a></h3>
<p>Create metrics for each customer:</p>
<ul class="simple">
<li><p>Purchase count</p></li>
<li><p>Average delivery time</p></li>
<li><p>Average delivery delay</p></li>
<li><p>Delayed order rate</p></li>
<li><p>Weekend purchase rate</p></li>
<li><p>Average inter-purchase time</p></li>
<li><p>Average payment count</p></li>
<li><p>Total payments</p></li>
<li><p>Average order value</p></li>
<li><p>Average single payment amount</p></li>
<li><p>Installment order rate</p></li>
<li><p>Average product count per order</p></li>
<li><p>Average unique product count</p></li>
<li><p>Average seller count per order</p></li>
<li><p>Total product value</p></li>
<li><p>Average product value</p></li>
<li><p>Average single product value</p></li>
<li><p>Average shipping cost</p></li>
<li><p>Average order weight</p></li>
<li><p>Average order volume</p></li>
<li><p>Free shipping rate</p></li>
<li><p>Review count</p></li>
<li><p>Average review score</p></li>
<li><p>Active months count</p></li>
<li><p>Max consecutive active months</p></li>
</ul>
<p>Create dimensions for each customer:</p>
<ul class="simple">
<li><p>Installment usage</p></li>
<li><p>Payment types</p></li>
<li><p>Top 3 purchase weekdays</p></li>
<li><p>Top 3 product categories</p></li>
<li><p>Top 3 generalized categories</p></li>
<li><p>First purchase date</p></li>
</ul>
<p><strong>Top 3 Weekdays</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)[</span><span class="s1">&#39;purchase_weekday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>purchase_weekday
1    91518
2     1619
3       76
4       17
5        5
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Aggregate top 3 weekdays by purchase frequency.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_purchase_weekdays</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;purchase_weekday&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>  
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span> 
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<span class="p">)</span>
<span class="n">top_purchase_weekdays</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">top_purchase_weekdays</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">customer_top_purchase_weekdays</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;purchase_weekday&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Top 3 Payment Types:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">payment_types</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_sales</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_payments</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">payment_types</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>payment_type
1    90805
2     2417
3       13
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Concatenate into string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">payment_types</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">payment_types</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">customer_payment_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payment_type&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Top 3 Product Categories:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_product_categories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_sales</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_products</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="n">top_product_categories</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category&#39;</span><span class="p">])</span>
<span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">])[</span><span class="s1">&#39;product_category&#39;</span><span class="p">]</span>
<span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>product_category
1    90973
2     2125
3      118
4       13
5        6
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Aggregate top 3 categories by frequency.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_product_categories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">top_product_categories</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>  
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span> 
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<span class="p">)</span>
<span class="n">top_product_categories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">top_product_categories</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">customer_top_product_categories</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_category&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Top 3 Generalized Categories</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_general_product_categories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_sales</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_products</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="n">top_general_product_categories</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;general_product_category&#39;</span><span class="p">])</span>
<span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">])[</span><span class="s1">&#39;general_product_category&#39;</span><span class="p">]</span>
<span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>general_product_category
1    91416
2     1737
3       72
4        9
5        1
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Aggregate top 3 categories by frequency.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_general_product_categories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">top_general_product_categories</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;general_product_category&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;general_product_category&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>  
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span> 
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<span class="p">)</span>
<span class="n">top_general_product_categories</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">top_general_product_categories</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">customer_top_general_product_categories</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;general_product_category&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span> <span class="o">=</span> <span class="n">df_sales</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;is_delayed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;is_delayed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Delayed&#39;</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;is_purchase_weekend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;purchase_day_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Weekend&#39;</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;order_has_installment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;order_has_installment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Has Installments&#39;</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Free Shipping&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">buys_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_delivery_time_days</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;delivery_time_days&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_delivery_delay_days</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;delivery_delay_days&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">delayed_orders_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_delayed&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">purchase_weekend_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_purchase_weekend&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">repeat_purchase_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sale_is_customer_first_purchase&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_payments_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;payments_cnt&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">total_customer_payment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_payment&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_total_order_payment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_payment&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_individual_payment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;avg_payment&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">installment_orders_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_has_installment&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;products_cnt&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_unique_products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;unique_products_cnt&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_sellers_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sellers_cnt&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_order_total_products_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_products_price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_total_order_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_order_price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_products_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;avg_products_price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">total_products_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_products_price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_order_total_freight_value</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_freight_value&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_order_total_weight_kg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_weight_kg&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_order_total_volume_cm3</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;total_volume_cm3&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">free_shipping_share</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_is_free_shipping&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">reviews_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;reviews_cnt&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">customer_avg_reviews_score</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_avg_reviews_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>      
        <span class="p">,</span> <span class="n">avg_distance_km</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;avg_distance_km&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">first_purchase_dt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">last_purchase_dt</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">from_first_to_second_days</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">from_first_to_last_days</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">top_purchase_weekdays</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">payment_types</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">top_product_categories</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">top_general_product_categories</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
          
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We calculated the average value of the column â€˜sale_is_customer_first_purchaseâ€™, but to get the proportion of repeat purchases, we need to subtract this value from 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;repeat_purchase_share&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;repeat_purchase_share&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Missing values in dimensions for customers without df_items orders will show â€˜No Order In Itemsâ€™.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_general_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_general_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Order in Items&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_purchase_weekdays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_purchase_weekdays&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_payment_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_payment_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_general_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="p">[</span><span class="s1">&#39;customer_top_general_product_categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Inter-purchase Time</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_sales</span><span class="p">[[</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">]]</span>
          <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">tmp_df_diff_days</span><span class="p">[</span><span class="s1">&#39;avg_buys_diff_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_df_diff_days</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">])[</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">]</span>
                  <span class="o">.</span><span class="n">diff</span><span class="p">()</span>
                  <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">tmp_df_diff_days</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;avg_buys_diff_days&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tmp_df_diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_df_diff_days</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
               <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg_buys_diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;avg_buys_diff_days&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
               <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_sales_agg</span><span class="p">,</span> <span class="n">tmp_df_diff_days</span><span class="p">,</span> <span class="s2">&quot;customer_unique_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_90dd4 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_90dd4 th {
  text-align: left;
}
#T_90dd4_row0_col0, #T_90dd4_row0_col1, #T_90dd4_row0_col2, #T_90dd4_row0_col3, #T_90dd4_row0_col4, #T_90dd4_row0_col5 {
  text-align: left;
}
</style>
<table id="T_90dd4">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_90dd4_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_90dd4_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_90dd4_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_90dd4_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_90dd4_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_90dd4_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_90dd4_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_90dd4_row0_col1" class="data row0 col1" >90,443</td>
      <td id="T_90dd4_row0_col2" class="data row0 col2" >0</td>
      <td id="T_90dd4_row0_col3" class="data row0 col3" >93,235</td>
      <td id="T_90dd4_row0_col4" class="data row0 col4" >2,792</td>
      <td id="T_90dd4_row0_col5" class="data row0 col5" >93,235</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>NA for single-purchase customers (expected).</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_diff_days</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Active Months</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_months_with_buys</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_sales</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">year_month</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">order_purchase_dt</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">months_with_buys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;year_month&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_months_with_buys</span><span class="o">.</span><span class="n">months_with_buys</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>months_with_buys
1    91550
2     1576
3       87
4       17
6        3
5        1
9        1
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_sales_agg</span><span class="p">,</span> <span class="n">tmp_df_months_with_buys</span><span class="p">,</span> <span class="s2">&quot;customer_unique_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_f6178 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_f6178 th {
  text-align: left;
}
#T_f6178_row0_col0, #T_f6178_row0_col1, #T_f6178_row0_col2, #T_f6178_row0_col3, #T_f6178_row0_col4, #T_f6178_row0_col5 {
  text-align: left;
}
</style>
<table id="T_f6178">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_f6178_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_f6178_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_f6178_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_f6178_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_f6178_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_f6178_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_f6178_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_f6178_row0_col1" class="data row0 col1" >0</td>
      <td id="T_f6178_row0_col2" class="data row0 col2" >0</td>
      <td id="T_f6178_row0_col3" class="data row0 col3" >93,235</td>
      <td id="T_f6178_row0_col4" class="data row0 col4" >93,235</td>
      <td id="T_f6178_row0_col5" class="data row0 col5" >93,235</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_months_with_buys</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Consecutive Active Months</strong></p>
<p>Count streaks of â‰¥2 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_max_months_with_buys</span> <span class="o">=</span> <span class="n">df_sales</span><span class="p">[[</span><span class="s1">&#39;order_purchase_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">]]</span>
<span class="n">tmp_df_max_months_with_buys</span><span class="p">[</span><span class="s1">&#39;year_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">order_purchase_dt</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="n">tmp_df_max_months_with_buys</span> <span class="o">=</span> <span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;year_month&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_max_months_with_buys</span> <span class="o">=</span> <span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;year_month&#39;</span><span class="p">])</span>
<span class="n">tmp_df_max_months_with_buys</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)[</span><span class="s1">&#39;year_month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
<span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tmp_df_max_months_with_buys</span><span class="p">[</span><span class="s1">&#39;is_diff_one_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_max_months_with_buys</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_max_consecutive_repeats_plus_on</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_max_months_with_buys</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tmp_df_max_months_with_buys</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">max_consecutive_months_with_buys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_diff_one_month&#39;</span><span class="p">,</span> <span class="n">get_max_consecutive_repeats_plus_on</span><span class="p">))</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_sales_agg</span><span class="p">,</span> <span class="n">tmp_df_max_months_with_buys</span><span class="p">,</span> <span class="s2">&quot;customer_unique_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_e19d3 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_e19d3 th {
  text-align: left;
}
#T_e19d3_row0_col0, #T_e19d3_row0_col1, #T_e19d3_row0_col2, #T_e19d3_row0_col3, #T_e19d3_row0_col4, #T_e19d3_row0_col5 {
  text-align: left;
}
</style>
<table id="T_e19d3">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_e19d3_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_e19d3_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_e19d3_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_e19d3_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_e19d3_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_e19d3_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_e19d3_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_e19d3_row0_col1" class="data row0 col1" >92,786</td>
      <td id="T_e19d3_row0_col2" class="data row0 col2" >0</td>
      <td id="T_e19d3_row0_col3" class="data row0 col3" >93,235</td>
      <td id="T_e19d3_row0_col4" class="data row0 col4" >449</td>
      <td id="T_e19d3_row0_col5" class="data row0 col5" >93,235</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We have many users who made purchases in only one month, so they have a missing value in the new field. We will replace it with 1 after merging.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_max_months_with_buys</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Replace NA with 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">max_consecutive_months_with_buys</span> <span class="o">=</span> <span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">max_consecutive_months_with_buys</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">tmp_df_sales_agg</span><span class="o">.</span><span class="n">max_consecutive_months_with_buys</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>max_consecutive_months_with_buys
1    92786
2      438
3        8
4        1
5        1
6        1
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p><strong>Merge with df_customers</strong></p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_customers</span><span class="p">,</span> <span class="n">tmp_df_sales_agg</span><span class="p">,</span> <span class="s2">&quot;customer_unique_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_117c3 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_117c3 th {
  text-align: left;
}
#T_117c3_row0_col0, #T_117c3_row0_col1, #T_117c3_row0_col2, #T_117c3_row0_col3, #T_117c3_row0_col4, #T_117c3_row0_col5 {
  text-align: left;
}
</style>
<table id="T_117c3">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_117c3_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_117c3_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_117c3_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_117c3_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_117c3_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_117c3_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_117c3_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_117c3_row0_col1" class="data row0 col1" >2,539</td>
      <td id="T_117c3_row0_col2" class="data row0 col2" >0</td>
      <td id="T_117c3_row0_col3" class="data row0 col3" >95,774</td>
      <td id="T_117c3_row0_col4" class="data row0 col4" >93,235</td>
      <td id="T_117c3_row0_col5" class="data row0 col5" >95,774</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Missing values occur for customers with only canceled orders.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_sales_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;customer_unique_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="from-table-df-geolocations">
<h3>From Table  df_geolocations<a class="headerlink" href="#from-table-df-geolocations" title="Link to this heading">#</a></h3>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_customers</span><span class="p">,</span> <span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;customer_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_5bbb9 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_5bbb9 th {
  text-align: left;
}
#T_5bbb9_row0_col0, #T_5bbb9_row0_col1, #T_5bbb9_row0_col2, #T_5bbb9_row0_col3, #T_5bbb9_row0_col4, #T_5bbb9_row0_col5 {
  text-align: left;
}
</style>
<table id="T_5bbb9">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_5bbb9_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_5bbb9_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_5bbb9_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_5bbb9_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_5bbb9_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_5bbb9_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_5bbb9_row0_col0" class="data row0 col0" >N:1</td>
      <td id="T_5bbb9_row0_col1" class="data row0 col1" >156</td>
      <td id="T_5bbb9_row0_col2" class="data row0 col2" >4,193</td>
      <td id="T_5bbb9_row0_col3" class="data row0 col3" >95,774</td>
      <td id="T_5bbb9_row0_col4" class="data row0 col4" >19,015</td>
      <td id="T_5bbb9_row0_col5" class="data row0 col5" >95,774</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>As we already found out, there are customers whose prefixes are not present in the geolocation table.</p>
<p>We need full prefixes only to calculate the distance between the customer and the seller.</p>
<p>For geo-analysis, we will use the truncated prefixes. Letâ€™s check if there are any missing rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_customers</span><span class="p">,</span> <span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;customer_zip_code_prefix_3_digits&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix_3_digits&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_a329f caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_a329f th {
  text-align: left;
}
#T_a329f_row0_col0, #T_a329f_row0_col1, #T_a329f_row0_col2, #T_a329f_row0_col3, #T_a329f_row0_col4, #T_a329f_row0_col5 {
  text-align: left;
}
</style>
<table id="T_a329f">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_a329f_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_a329f_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_a329f_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_a329f_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_a329f_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_a329f_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_a329f_row0_col0" class="data row0 col0" >N:M</td>
      <td id="T_a329f_row0_col1" class="data row0 col1" >0</td>
      <td id="T_a329f_row0_col2" class="data row0 col2" >5</td>
      <td id="T_a329f_row0_col3" class="data row0 col3" >95,774</td>
      <td id="T_a329f_row0_col4" class="data row0 col4" >19,015</td>
      <td id="T_a329f_row0_col5" class="data row0 col5" >3,109,891</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>With geo-analysis, there will be no problems. The issue is only with calculating the distance.</p>
<p>We can try to fill in the coordinates based on the truncated prefixes and calculate the coordinates.</p>
<p>However, this will clearly result in significant error, and we want to preserve accuracy.</p>
<p>If we fill in these missing values, we will introduce more distortion into the data than gain any benefit.</p>
<p>Given that there are few missing rows, we will simply leave them as is and analyze the distance without them.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;customer_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df_customers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;geolocation_lat&#39;</span><span class="p">:</span> <span class="s1">&#39;lat_customer&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_lng&#39;</span><span class="p">:</span> <span class="s1">&#39;lng_customer&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_zip_code_prefix_3_digits&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s look at the missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">explore</span><span class="o">.</span><span class="n">detect_anomalies</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_237e7 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_237e7 th {
  text-align: left;
}
#T_237e7_row0_col0, #T_237e7_row0_col1, #T_237e7_row1_col0, #T_237e7_row1_col1, #T_237e7_row2_col0, #T_237e7_row2_col1, #T_237e7_row3_col0, #T_237e7_row3_col1, #T_237e7_row4_col0, #T_237e7_row4_col1, #T_237e7_row5_col0, #T_237e7_row5_col1, #T_237e7_row6_col0, #T_237e7_row6_col1, #T_237e7_row7_col0, #T_237e7_row7_col1, #T_237e7_row8_col0, #T_237e7_row8_col1, #T_237e7_row9_col0, #T_237e7_row9_col1, #T_237e7_row10_col0, #T_237e7_row10_col1, #T_237e7_row11_col0, #T_237e7_row11_col1, #T_237e7_row12_col0, #T_237e7_row12_col1, #T_237e7_row13_col0, #T_237e7_row13_col1, #T_237e7_row14_col0, #T_237e7_row14_col1, #T_237e7_row15_col0, #T_237e7_row15_col1, #T_237e7_row16_col0, #T_237e7_row16_col1, #T_237e7_row17_col0, #T_237e7_row17_col1, #T_237e7_row18_col0, #T_237e7_row18_col1, #T_237e7_row19_col0, #T_237e7_row19_col1, #T_237e7_row20_col0, #T_237e7_row20_col1, #T_237e7_row21_col0, #T_237e7_row21_col1, #T_237e7_row22_col0, #T_237e7_row22_col1, #T_237e7_row23_col0, #T_237e7_row23_col1, #T_237e7_row24_col0, #T_237e7_row24_col1, #T_237e7_row25_col0, #T_237e7_row25_col1, #T_237e7_row26_col0, #T_237e7_row26_col1, #T_237e7_row27_col0, #T_237e7_row27_col1, #T_237e7_row28_col0, #T_237e7_row28_col1, #T_237e7_row29_col0, #T_237e7_row29_col1, #T_237e7_row30_col0, #T_237e7_row30_col1, #T_237e7_row31_col0, #T_237e7_row31_col1, #T_237e7_row32_col0, #T_237e7_row32_col1, #T_237e7_row33_col0, #T_237e7_row33_col1, #T_237e7_row34_col0, #T_237e7_row34_col1, #T_237e7_row35_col0, #T_237e7_row35_col1, #T_237e7_row36_col0, #T_237e7_row36_col1, #T_237e7_row37_col0, #T_237e7_row37_col1, #T_237e7_row38_col0, #T_237e7_row38_col1 {
  text-align: left;
}
</style>
<table id="T_237e7">
  <caption>Missings by Column</caption>
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_237e7_level0_col0" class="col_heading level0 col0" >Count</th>
      <th id="T_237e7_level0_col1" class="col_heading level0 col1" >Percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_237e7_level0_row0" class="row_heading level0 row0" >buys_cnt</th>
      <td id="T_237e7_row0_col0" class="data row0 col0" >2539</td>
      <td id="T_237e7_row0_col1" class="data row0 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row1" class="row_heading level0 row1" >avg_delivery_time_days</th>
      <td id="T_237e7_row1_col0" class="data row1 col0" >2670</td>
      <td id="T_237e7_row1_col1" class="data row1 col1" >2.79%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row2" class="row_heading level0 row2" >avg_delivery_delay_days</th>
      <td id="T_237e7_row2_col0" class="data row2 col0" >2670</td>
      <td id="T_237e7_row2_col1" class="data row2 col1" >2.79%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row3" class="row_heading level0 row3" >delayed_orders_share</th>
      <td id="T_237e7_row3_col0" class="data row3 col0" >2539</td>
      <td id="T_237e7_row3_col1" class="data row3 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row4" class="row_heading level0 row4" >purchase_weekend_share</th>
      <td id="T_237e7_row4_col0" class="data row4 col0" >2539</td>
      <td id="T_237e7_row4_col1" class="data row4 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row5" class="row_heading level0 row5" >repeat_purchase_share</th>
      <td id="T_237e7_row5_col0" class="data row5 col0" >2539</td>
      <td id="T_237e7_row5_col1" class="data row5 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row6" class="row_heading level0 row6" >avg_payments_cnt</th>
      <td id="T_237e7_row6_col0" class="data row6 col0" >2539</td>
      <td id="T_237e7_row6_col1" class="data row6 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row7" class="row_heading level0 row7" >total_customer_payment</th>
      <td id="T_237e7_row7_col0" class="data row7 col0" >2539</td>
      <td id="T_237e7_row7_col1" class="data row7 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row8" class="row_heading level0 row8" >avg_total_order_payment</th>
      <td id="T_237e7_row8_col0" class="data row8 col0" >2539</td>
      <td id="T_237e7_row8_col1" class="data row8 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row9" class="row_heading level0 row9" >avg_individual_payment</th>
      <td id="T_237e7_row9_col0" class="data row9 col0" >2539</td>
      <td id="T_237e7_row9_col1" class="data row9 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row10" class="row_heading level0 row10" >installment_orders_share</th>
      <td id="T_237e7_row10_col0" class="data row10 col0" >2539</td>
      <td id="T_237e7_row10_col1" class="data row10 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row11" class="row_heading level0 row11" >avg_products_cnt</th>
      <td id="T_237e7_row11_col0" class="data row11 col0" >2539</td>
      <td id="T_237e7_row11_col1" class="data row11 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row12" class="row_heading level0 row12" >avg_unique_products_cnt</th>
      <td id="T_237e7_row12_col0" class="data row12 col0" >2539</td>
      <td id="T_237e7_row12_col1" class="data row12 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row13" class="row_heading level0 row13" >avg_sellers_cnt</th>
      <td id="T_237e7_row13_col0" class="data row13 col0" >2539</td>
      <td id="T_237e7_row13_col1" class="data row13 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row14" class="row_heading level0 row14" >avg_order_total_products_price</th>
      <td id="T_237e7_row14_col0" class="data row14 col0" >2539</td>
      <td id="T_237e7_row14_col1" class="data row14 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row15" class="row_heading level0 row15" >avg_total_order_price</th>
      <td id="T_237e7_row15_col0" class="data row15 col0" >2539</td>
      <td id="T_237e7_row15_col1" class="data row15 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row16" class="row_heading level0 row16" >avg_products_price</th>
      <td id="T_237e7_row16_col0" class="data row16 col0" >2539</td>
      <td id="T_237e7_row16_col1" class="data row16 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row17" class="row_heading level0 row17" >total_products_price</th>
      <td id="T_237e7_row17_col0" class="data row17 col0" >2539</td>
      <td id="T_237e7_row17_col1" class="data row17 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row18" class="row_heading level0 row18" >avg_order_total_freight_value</th>
      <td id="T_237e7_row18_col0" class="data row18 col0" >2539</td>
      <td id="T_237e7_row18_col1" class="data row18 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row19" class="row_heading level0 row19" >avg_order_total_weight_kg</th>
      <td id="T_237e7_row19_col0" class="data row19 col0" >2539</td>
      <td id="T_237e7_row19_col1" class="data row19 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row20" class="row_heading level0 row20" >avg_order_total_volume_cm3</th>
      <td id="T_237e7_row20_col0" class="data row20 col0" >2539</td>
      <td id="T_237e7_row20_col1" class="data row20 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row21" class="row_heading level0 row21" >free_shipping_share</th>
      <td id="T_237e7_row21_col0" class="data row21 col0" >2539</td>
      <td id="T_237e7_row21_col1" class="data row21 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row22" class="row_heading level0 row22" >reviews_cnt</th>
      <td id="T_237e7_row22_col0" class="data row22 col0" >2539</td>
      <td id="T_237e7_row22_col1" class="data row22 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row23" class="row_heading level0 row23" >customer_avg_reviews_score</th>
      <td id="T_237e7_row23_col0" class="data row23 col0" >2539</td>
      <td id="T_237e7_row23_col1" class="data row23 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row24" class="row_heading level0 row24" >avg_distance_km</th>
      <td id="T_237e7_row24_col0" class="data row24 col0" >2992</td>
      <td id="T_237e7_row24_col1" class="data row24 col1" >3.12%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row25" class="row_heading level0 row25" >first_purchase_dt</th>
      <td id="T_237e7_row25_col0" class="data row25 col0" >2539</td>
      <td id="T_237e7_row25_col1" class="data row25 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row26" class="row_heading level0 row26" >last_purchase_dt</th>
      <td id="T_237e7_row26_col0" class="data row26 col0" >2539</td>
      <td id="T_237e7_row26_col1" class="data row26 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row27" class="row_heading level0 row27" >from_first_to_second_days</th>
      <td id="T_237e7_row27_col0" class="data row27 col0" >92982</td>
      <td id="T_237e7_row27_col1" class="data row27 col1" >97.08%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row28" class="row_heading level0 row28" >from_first_to_last_days</th>
      <td id="T_237e7_row28_col0" class="data row28 col0" >92982</td>
      <td id="T_237e7_row28_col1" class="data row28 col1" >97.08%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row29" class="row_heading level0 row29" >customer_top_purchase_weekdays</th>
      <td id="T_237e7_row29_col0" class="data row29 col0" >2539</td>
      <td id="T_237e7_row29_col1" class="data row29 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row30" class="row_heading level0 row30" >customer_payment_types</th>
      <td id="T_237e7_row30_col0" class="data row30 col0" >2539</td>
      <td id="T_237e7_row30_col1" class="data row30 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row31" class="row_heading level0 row31" >customer_top_product_categories</th>
      <td id="T_237e7_row31_col0" class="data row31 col0" >2539</td>
      <td id="T_237e7_row31_col1" class="data row31 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row32" class="row_heading level0 row32" >customer_top_general_product_categories</th>
      <td id="T_237e7_row32_col0" class="data row32 col0" >2539</td>
      <td id="T_237e7_row32_col1" class="data row32 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row33" class="row_heading level0 row33" >avg_buys_diff_days</th>
      <td id="T_237e7_row33_col0" class="data row33 col0" >92982</td>
      <td id="T_237e7_row33_col1" class="data row33 col1" >97.08%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row34" class="row_heading level0 row34" >months_with_buys</th>
      <td id="T_237e7_row34_col0" class="data row34 col0" >2539</td>
      <td id="T_237e7_row34_col1" class="data row34 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row35" class="row_heading level0 row35" >max_consecutive_months_with_buys</th>
      <td id="T_237e7_row35_col0" class="data row35 col0" >2539</td>
      <td id="T_237e7_row35_col1" class="data row35 col1" >2.65%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row36" class="row_heading level0 row36" >lat_customer</th>
      <td id="T_237e7_row36_col0" class="data row36 col0" >268</td>
      <td id="T_237e7_row36_col1" class="data row36 col1" >0.28%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row37" class="row_heading level0 row37" >lng_customer</th>
      <td id="T_237e7_row37_col0" class="data row37 col0" >268</td>
      <td id="T_237e7_row37_col1" class="data row37 col1" >0.28%</td>
    </tr>
    <tr>
      <th id="T_237e7_level0_row38" class="row_heading level0 row38" >in_south_america</th>
      <td id="T_237e7_row38_col0" class="data row38 col0" >268</td>
      <td id="T_237e7_row38_col1" class="data row38 col1" >0.28%</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>All missing values are expected.</p>
<p>Missing values are for customers who did not make any successful purchases.</p>
<p>We will replace the missing values in the measurements with â€˜Never Convertedâ€™.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_top_purchase_weekdays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_top_purchase_weekdays&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_payment_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_payment_types&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_top_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_top_product_categories&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_top_general_product_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;customer_top_general_product_categories&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="customer-segmentation">
<h3>Customer Segmentation<a class="headerlink" href="#customer-segmentation" title="Link to this heading">#</a></h3>
<p>Based on customer metrics, we will segment the customers.</p>
<p>**Monetary Value **</p>
<p>Examine quantiles in the total_customer_payment column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">total_customer_payment</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00        9.59
0.05       32.69
0.25       63.06
0.50      107.78
0.75      182.46
0.95      469.33
1.00   13,664.08
Name: total_customer_payment, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Low value: payments up to 63 R$ inclusive</p></li>
<li><p>Medium value: payments from 63 to 182 R$ inclusive</p></li>
<li><p>High value: payments above 182 R$</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;value_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">total_customer_payment</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Medium</th>
      <td>46579</td>
    </tr>
    <tr>
      <th>High</th>
      <td>23370</td>
    </tr>
    <tr>
      <th>Low</th>
      <td>23286</td>
    </tr>
    <tr>
      <th>Never Converted</th>
      <td>2539</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<hr class="docutils" />
<p><strong>Activity</strong></p>
<p>We identify the following segments:</p>
<ul class="simple">
<li><p>Non-converted: customers who didnâ€™t complete any successful purchases</p></li>
<li><p>Core customers:</p>
<ul>
<li><p>Completed 3 or more purchases</p></li>
<li><p>Time between first and last purchase is 60 days or more</p></li>
</ul>
</li>
<li><p>Potential core:</p>
<ul>
<li><p>Completed 2 or more purchases</p></li>
<li><p>Time between first and last purchase is 30 days or less</p></li>
</ul>
</li>
<li><p>Short-term repeaters:</p>
<ul>
<li><p>Completed more than 2 purchases</p></li>
<li><p>Time between first and last purchase is less than 30 days</p></li>
</ul>
</li>
<li><p>One-time buyers: completed only one purchase</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">=</span> <span class="n">df_sales</span><span class="o">.</span><span class="n">order_purchase_dt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;first_purchase_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="c1"># No Successful Purchases</span>
    <span class="p">,</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;buys_cnt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;from_first_to_last_days&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="c1"># Core</span>
    <span class="p">,</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;buys_cnt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;from_first_to_last_days&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># Potential Core</span>
    <span class="p">,</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;buys_cnt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;from_first_to_last_days&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># Short-Lived Repeat</span>
    <span class="p">,</span> <span class="p">(</span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;buys_cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># One-Time</span>
<span class="p">]</span>
<span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">,</span> <span class="s1">&#39;Core&#39;</span><span class="p">,</span> <span class="s1">&#39;Potential Core&#39;</span><span class="p">,</span> <span class="s1">&#39;Short-Lived Repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;One Time&#39;</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;activity_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Other&#39;</span><span class="p">)</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;activity_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;activity_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;activity_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>activity_segment
One Time              90443
Never Converted        2539
Short-Lived Repeat     1341
Potential Core         1293
Core                    158
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Examine quantiles in the avg_buys_diff_days column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">avg_buys_diff_days</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00     0.00
0.05     0.00
0.25     0.01
0.50    32.60
0.75   124.55
0.95   311.36
1.00   582.86
Name: avg_buys_diff_days, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Weekly</p></li>
<li><p>Monthly</p></li>
<li><p>Quarterly</p></li>
<li><p>Semiannual</p></li>
<li><p>Annual</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Weekly&#39;</span><span class="p">,</span> <span class="s1">&#39;Monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;Quarterly&#39;</span><span class="p">,</span> <span class="s1">&#39;Semiannual&#39;</span><span class="p">,</span> <span class="s1">&#39;Annual&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;purchase_freq_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">avg_buys_diff_days</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NaN</th>
      <td>92982</td>
    </tr>
    <tr>
      <th>Weekly</th>
      <td>971</td>
    </tr>
    <tr>
      <th>Quarterly</th>
      <td>534</td>
    </tr>
    <tr>
      <th>Annual</th>
      <td>460</td>
    </tr>
    <tr>
      <th>Semiannual</th>
      <td>431</td>
    </tr>
    <tr>
      <th>Monthly</th>
      <td>396</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Missing values require two-step replacement as they occur for both non-converted customers and those without any purchases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_one_time</span> <span class="o">=</span> <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;buys_cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">mask_never_converted</span> <span class="o">=</span> <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;buys_cnt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>

<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;purchase_freq_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;purchase_freq_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">([</span><span class="s1">&#39;Non-Repeating&#39;</span><span class="p">,</span> <span class="s1">&#39;Never Converted&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">df_customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_one_time</span><span class="p">,</span> <span class="s1">&#39;purchase_freq_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Non-Repeating&#39;</span>
<span class="n">df_customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_never_converted</span><span class="p">,</span> <span class="s1">&#39;purchase_freq_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Never Converted&#39;</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;purchase_freq_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>purchase_freq_segment
Non-Repeating      90443
Never Converted     2539
Weekly               971
Quarterly            534
Annual               460
Semiannual           431
Monthly              396
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Examine quantiles in the from_first_to_second_days column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">from_first_to_second_days</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00     0.00
0.05     0.00
0.25     0.00
0.50    28.91
0.75   125.49
0.95   318.98
1.00   582.86
Name: from_first_to_second_days, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Fast repeaters: repurchase within 14 days</p></li>
<li><p>Medium repeaters: repurchase in 14-60 days</p></li>
<li><p>Slow repeaters: repurchase after 60 days</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fast Repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium Repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;Slow Repeat&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;repeat_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">from_first_to_second_days</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NaN</th>
      <td>92982</td>
    </tr>
    <tr>
      <th>Fast Repeat</th>
      <td>1169</td>
    </tr>
    <tr>
      <th>Slow Repeat</th>
      <td>1087</td>
    </tr>
    <tr>
      <th>Medium Repeat</th>
      <td>536</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We replace missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;repeat_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;repeat_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">([</span><span class="s1">&#39;Non-Repeating&#39;</span><span class="p">,</span> <span class="s1">&#39;Never Converted&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">df_customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_one_time</span><span class="p">,</span> <span class="s1">&#39;repeat_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Non-Repeating&#39;</span>
<span class="n">df_customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_never_converted</span><span class="p">,</span> <span class="s1">&#39;repeat_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Never Converted&#39;</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;repeat_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>repeat_segment
Non-Repeating      90443
Never Converted     2539
Fast Repeat         1169
Slow Repeat         1087
Medium Repeat        536
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><strong>Loyalty</strong></p>
<p>Examine quantiles in the customer_avg_reviews_score column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">customer_avg_reviews_score</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00   1.00
0.05   1.00
0.25   4.00
0.50   5.00
0.75   5.00
0.95   5.00
1.00   5.00
Name: customer_avg_reviews_score, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Critics: average score below 3</p></li>
<li><p>Neutral: average score 3-4</p></li>
<li><p>Promoters: average score 5</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Critic&#39;</span><span class="p">,</span> <span class="s1">&#39;Neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;Promoter&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;loyalty_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">customer_avg_reviews_score</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Promoter</th>
      <td>54386</td>
    </tr>
    <tr>
      <th>Neutral</th>
      <td>26534</td>
    </tr>
    <tr>
      <th>Critic</th>
      <td>12315</td>
    </tr>
    <tr>
      <th>Never Converted</th>
      <td>2539</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<hr class="docutils" />
<p><strong>Risk Segment</strong></p>
<p>Examine quantiles in the canceled_share column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">canceled_share</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00   0.00
0.05   0.00
0.25   0.00
0.50   0.00
0.75   0.00
0.95   0.00
1.00   1.00
Name: canceled_share, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Reliable: 0% cancellation rate</p></li>
<li><p>Risky: cancellation rate above 0%</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Reliable&#39;</span><span class="p">,</span> <span class="s1">&#39;Risky&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;risk_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">canceled_share</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Reliable</th>
      <td>95197</td>
    </tr>
    <tr>
      <th>Risky</th>
      <td>577</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<hr class="docutils" />
<p><strong>Customer Behavioral Characteristics</strong></p>
<p>Examine quantiles in the purchase_weekend_share column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">purchase_weekend_share</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00   0.00
0.05   0.00
0.25   0.00
0.50   0.00
0.75   0.00
0.95   1.00
1.00   1.00
Name: purchase_weekend_share, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Weekday buyers: 0% weekend purchases</p></li>
<li><p>Weekend buyers: weekend purchases above 0%</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Weekday&#39;</span><span class="p">,</span> <span class="s1">&#39;Weekend&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;weekday_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">purchase_weekend_share</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Weekday</th>
      <td>71456</td>
    </tr>
    <tr>
      <th>Weekend</th>
      <td>21779</td>
    </tr>
    <tr>
      <th>Never Converted</th>
      <td>2539</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Examine quantiles in the installment_orders_share column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">installment_orders_share</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00   0.00
0.05   0.00
0.25   0.00
0.50   1.00
0.75   1.00
0.95   1.00
1.00   1.00
Name: installment_orders_share, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Full payment: 0% installment orders</p></li>
<li><p>Installment users: installment orders above 0%</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Full Pay&#39;</span><span class="p">,</span> <span class="s1">&#39;Installment&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;installment_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">installment_orders_share</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Installment</th>
      <td>48124</td>
    </tr>
    <tr>
      <th>Full Pay</th>
      <td>45111</td>
    </tr>
    <tr>
      <th>Never Converted</th>
      <td>2539</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<hr class="docutils" />
<p><strong>Order Characteristics</strong></p>
<p>Examine quantiles in the avg_products_cnt column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">avg_products_cnt</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00    1.00
0.05    1.00
0.25    1.00
0.50    1.00
0.75    1.00
0.95    2.00
1.00   21.00
Name: avg_products_cnt, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Single product buyers: average 1 product per order</p></li>
<li><p>Multi-product buyers: average 1-2 products per order</p></li>
<li><p>Bulk buyers: average more than 2 products per order</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Single Product&#39;</span><span class="p">,</span> <span class="s1">&#39;Multi Product&#39;</span><span class="p">,</span> <span class="s1">&#39;Bulk Buyer&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;products_cnt_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">avg_products_cnt</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Single Product</th>
      <td>83774</td>
    </tr>
    <tr>
      <th>Multi Product</th>
      <td>7372</td>
    </tr>
    <tr>
      <th>Never Converted</th>
      <td>2539</td>
    </tr>
    <tr>
      <th>Bulk Buyer</th>
      <td>2089</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Examine quantiles in the avg_order_total_weight_kg column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_customers</span><span class="o">.</span><span class="n">avg_order_total_weight_kg</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00     0.00
0.05     0.15
0.25     0.30
0.50     0.75
0.75     2.10
0.95    10.48
1.00   184.40
Name: avg_order_total_weight_kg, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We create the following segments:</p>
<ul class="simple">
<li><p>Light orders: average up to 0.5 kg</p></li>
<li><p>Medium orders: average 0.5-2.5 kg</p></li>
<li><p>Heavy orders: average more than 2.5 kg</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span> <span class="s1">&#39;Heavy&#39;</span><span class="p">]</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">df_customers</span><span class="p">[</span><span class="s1">&#39;weight_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_customers</span><span class="o">.</span><span class="n">avg_order_total_weight_kg</span><span class="o">.</span><span class="n">preproc</span>
    <span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;custom_bins&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">fill_na_value</span><span class="o">=</span><span class="s1">&#39;Never Converted&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Light</th>
      <td>37333</td>
    </tr>
    <tr>
      <th>Medium</th>
      <td>35503</td>
    </tr>
    <tr>
      <th>Heavy</th>
      <td>20399</td>
    </tr>
    <tr>
      <th>Never Converted</th>
      <td>2539</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="enriching-table-df-products">
<h2>Enriching Table df_products<a class="headerlink" href="#enriching-table-df-products" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>From Table  df_orders<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>We will create the following metrics for each product:</p>
<ul class="simple">
<li><p>Count of canceled orders containing this product</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_products_canceled</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_orders</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">order_status</span> <span class="o">==</span> <span class="s1">&#39;Canceled&#39;</span><span class="p">][[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">product_canceled_orders_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will merge this with the main products dataframe.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_products</span><span class="p">,</span> <span class="n">tmp_df_products_canceled</span><span class="p">,</span> <span class="s2">&quot;product_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_f4f1d caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_f4f1d th {
  text-align: left;
}
#T_f4f1d_row0_col0, #T_f4f1d_row0_col1, #T_f4f1d_row0_col2, #T_f4f1d_row0_col3, #T_f4f1d_row0_col4, #T_f4f1d_row0_col5 {
  text-align: left;
}
</style>
<table id="T_f4f1d">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_f4f1d_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_f4f1d_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_f4f1d_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_f4f1d_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_f4f1d_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_f4f1d_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_f4f1d_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_f4f1d_row0_col1" class="data row0 col1" >32,528</td>
      <td id="T_f4f1d_row0_col2" class="data row0 col2" >0</td>
      <td id="T_f4f1d_row0_col3" class="data row0 col3" >32,951</td>
      <td id="T_f4f1d_row0_col4" class="data row0 col4" >423</td>
      <td id="T_f4f1d_row0_col5" class="data row0 col5" >32,951</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Missing values will appear for products that were not part of canceled orders.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_products</span> <span class="o">=</span> <span class="n">df_products</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_products_canceled</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>From Table  df_sales<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>We will create the following additional metrics for each product:</p>
<ul class="simple">
<li><p>Count of orders containing this product</p></li>
<li><p>Total units sold of this product</p></li>
<li><p>Total sales value for this product</p></li>
<li><p>Average quantity of this product per order</p></li>
<li><p>Average share of this product in order by quantity</p></li>
<li><p>Average share of this product in order by value</p></li>
<li><p>Average price of product over all time</p></li>
<li><p>Maximum price of product</p></li>
<li><p>Minimum price of product</p></li>
<li><p>Price range</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_products</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_sales</span><span class="p">[[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">product_sales_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">total_units_sold</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">total_sales_amount</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">min_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">max_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">tmp_df_products</span><span class="p">[</span><span class="s1">&#39;price_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_products</span><span class="p">[</span><span class="s1">&#39;max_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmp_df_products</span><span class="p">[</span><span class="s1">&#39;min_price&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We will calculate average shares in orders.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_products_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_sales</span><span class="p">[[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                          <span class="n">product_qty</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
                          <span class="p">,</span> <span class="n">product_total_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
                      <span class="p">)</span>
<span class="p">)</span>
<span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;products_cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_products_share</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">product_qty</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
<span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;order_total_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_products_share</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">product_total_price</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
<span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;product_qty_share_per_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;product_qty&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;products_cnt&#39;</span><span class="p">]</span>
<span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;order_total_price_share_per_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;product_total_price&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">tmp_df_products_share</span><span class="p">[</span><span class="s1">&#39;order_total_price&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_products_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_df_products_share</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                          <span class="n">avg_product_qty_per_order</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_qty&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
                          <span class="p">,</span> <span class="n">avg_product_qty_share_per_order</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_qty_share_per_order&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
                          <span class="p">,</span> <span class="n">avg_order_total_price_share_per_order</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_total_price_share_per_order&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
                      <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Merge tables.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_products</span><span class="p">,</span> <span class="n">tmp_df_products_share</span><span class="p">,</span> <span class="s2">&quot;product_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_dd10e caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_dd10e th {
  text-align: left;
}
#T_dd10e_row0_col0, #T_dd10e_row0_col1, #T_dd10e_row0_col2, #T_dd10e_row0_col3, #T_dd10e_row0_col4, #T_dd10e_row0_col5 {
  text-align: left;
}
</style>
<table id="T_dd10e">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_dd10e_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_dd10e_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_dd10e_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_dd10e_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_dd10e_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_dd10e_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_dd10e_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_dd10e_row0_col1" class="data row0 col1" >0</td>
      <td id="T_dd10e_row0_col2" class="data row0 col2" >0</td>
      <td id="T_dd10e_row0_col3" class="data row0 col3" >32,122</td>
      <td id="T_dd10e_row0_col4" class="data row0 col4" >32,122</td>
      <td id="T_dd10e_row0_col5" class="data row0 col5" >32,122</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_products</span> <span class="o">=</span> <span class="n">tmp_df_products</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_products_share</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will merge this with the main products dataframe.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_products</span><span class="p">,</span> <span class="n">tmp_df_products</span><span class="p">,</span> <span class="s2">&quot;product_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_91e4a caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_91e4a th {
  text-align: left;
}
#T_91e4a_row0_col0, #T_91e4a_row0_col1, #T_91e4a_row0_col2, #T_91e4a_row0_col3, #T_91e4a_row0_col4, #T_91e4a_row0_col5 {
  text-align: left;
}
</style>
<table id="T_91e4a">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_91e4a_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_91e4a_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_91e4a_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_91e4a_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_91e4a_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_91e4a_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_91e4a_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_91e4a_row0_col1" class="data row0 col1" >829</td>
      <td id="T_91e4a_row0_col2" class="data row0 col2" >0</td>
      <td id="T_91e4a_row0_col3" class="data row0 col3" >32,951</td>
      <td id="T_91e4a_row0_col4" class="data row0 col4" >32,122</td>
      <td id="T_91e4a_row0_col5" class="data row0 col5" >32,951</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Missing values will appear for products that were never sold.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_products</span> <span class="o">=</span> <span class="n">df_products</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_products</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s look at the missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_products</span><span class="o">.</span><span class="n">explore</span><span class="o">.</span><span class="n">detect_anomalies</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_fa4c4 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_fa4c4 th {
  text-align: left;
}
#T_fa4c4_row0_col0, #T_fa4c4_row0_col1, #T_fa4c4_row1_col0, #T_fa4c4_row1_col1, #T_fa4c4_row2_col0, #T_fa4c4_row2_col1, #T_fa4c4_row3_col0, #T_fa4c4_row3_col1, #T_fa4c4_row4_col0, #T_fa4c4_row4_col1, #T_fa4c4_row5_col0, #T_fa4c4_row5_col1, #T_fa4c4_row6_col0, #T_fa4c4_row6_col1, #T_fa4c4_row7_col0, #T_fa4c4_row7_col1, #T_fa4c4_row8_col0, #T_fa4c4_row8_col1, #T_fa4c4_row9_col0, #T_fa4c4_row9_col1, #T_fa4c4_row10_col0, #T_fa4c4_row10_col1, #T_fa4c4_row11_col0, #T_fa4c4_row11_col1, #T_fa4c4_row12_col0, #T_fa4c4_row12_col1 {
  text-align: left;
}
</style>
<table id="T_fa4c4">
  <caption>Missings by Column</caption>
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_fa4c4_level0_col0" class="col_heading level0 col0" >Count</th>
      <th id="T_fa4c4_level0_col1" class="col_heading level0 col1" >Percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_fa4c4_level0_row0" class="row_heading level0 row0" >product_name_lenght</th>
      <td id="T_fa4c4_row0_col0" class="data row0 col0" >610</td>
      <td id="T_fa4c4_row0_col1" class="data row0 col1" >1.85%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row1" class="row_heading level0 row1" >product_description_lenght</th>
      <td id="T_fa4c4_row1_col0" class="data row1 col0" >610</td>
      <td id="T_fa4c4_row1_col1" class="data row1 col1" >1.85%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row2" class="row_heading level0 row2" >product_canceled_orders_cnt</th>
      <td id="T_fa4c4_row2_col0" class="data row2 col0" >32528</td>
      <td id="T_fa4c4_row2_col1" class="data row2 col1" >98.72%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row3" class="row_heading level0 row3" >product_sales_cnt</th>
      <td id="T_fa4c4_row3_col0" class="data row3 col0" >829</td>
      <td id="T_fa4c4_row3_col1" class="data row3 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row4" class="row_heading level0 row4" >total_units_sold</th>
      <td id="T_fa4c4_row4_col0" class="data row4 col0" >829</td>
      <td id="T_fa4c4_row4_col1" class="data row4 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row5" class="row_heading level0 row5" >total_sales_amount</th>
      <td id="T_fa4c4_row5_col0" class="data row5 col0" >829</td>
      <td id="T_fa4c4_row5_col1" class="data row5 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row6" class="row_heading level0 row6" >avg_price</th>
      <td id="T_fa4c4_row6_col0" class="data row6 col0" >829</td>
      <td id="T_fa4c4_row6_col1" class="data row6 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row7" class="row_heading level0 row7" >min_price</th>
      <td id="T_fa4c4_row7_col0" class="data row7 col0" >829</td>
      <td id="T_fa4c4_row7_col1" class="data row7 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row8" class="row_heading level0 row8" >max_price</th>
      <td id="T_fa4c4_row8_col0" class="data row8 col0" >829</td>
      <td id="T_fa4c4_row8_col1" class="data row8 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row9" class="row_heading level0 row9" >price_range</th>
      <td id="T_fa4c4_row9_col0" class="data row9 col0" >829</td>
      <td id="T_fa4c4_row9_col1" class="data row9 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row10" class="row_heading level0 row10" >avg_product_qty_per_order</th>
      <td id="T_fa4c4_row10_col0" class="data row10 col0" >829</td>
      <td id="T_fa4c4_row10_col1" class="data row10 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row11" class="row_heading level0 row11" >avg_product_qty_share_per_order</th>
      <td id="T_fa4c4_row11_col0" class="data row11 col0" >829</td>
      <td id="T_fa4c4_row11_col1" class="data row11 col1" >2.52%</td>
    </tr>
    <tr>
      <th id="T_fa4c4_level0_row12" class="row_heading level0 row12" >avg_order_total_price_share_per_order</th>
      <td id="T_fa4c4_row12_col0" class="data row12 col0" >829</td>
      <td id="T_fa4c4_row12_col1" class="data row12 col1" >2.52%</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>All missing values are expected.</p>
</section>
</section>
<section id="enriching-table-df-sellers">
<h2>Enriching Table df_sellers<a class="headerlink" href="#enriching-table-df-sellers" title="Link to this heading">#</a></h2>
<section id="id3">
<h3>From Tables df_items and df_products<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>From Table <code class="docutils literal notranslate"><span class="pre">df_items</span></code> we will select only sales.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">df_sales</span><span class="p">[[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]],</span> <span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_70a66 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_70a66 th {
  text-align: left;
}
#T_70a66_row0_col0, #T_70a66_row0_col1, #T_70a66_row0_col2, #T_70a66_row0_col3, #T_70a66_row0_col4, #T_70a66_row0_col5 {
  text-align: left;
}
</style>
<table id="T_70a66">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_70a66_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_70a66_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_70a66_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_70a66_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_70a66_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_70a66_level0_col5" class="col_heading level0 col5" >Inner join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_70a66_row0_col0" class="data row0 col0" >N:1</td>
      <td id="T_70a66_row0_col1" class="data row0 col1" >2,007</td>
      <td id="T_70a66_row0_col2" class="data row0 col2" >0</td>
      <td id="T_70a66_row0_col3" class="data row0 col3" >112,279</td>
      <td id="T_70a66_row0_col4" class="data row0 col4" >96,346</td>
      <td id="T_70a66_row0_col5" class="data row0 col5" >110,021</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items</span> <span class="o">=</span> <span class="n">df_items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_sales</span><span class="p">[[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will add product information.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_items</span><span class="p">,</span> <span class="n">df_products</span><span class="p">,</span> <span class="s2">&quot;product_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_18b3f caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_18b3f th {
  text-align: left;
}
#T_18b3f_row0_col0, #T_18b3f_row0_col1, #T_18b3f_row0_col2, #T_18b3f_row0_col3, #T_18b3f_row0_col4, #T_18b3f_row0_col5 {
  text-align: left;
}
</style>
<table id="T_18b3f">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_18b3f_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_18b3f_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_18b3f_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_18b3f_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_18b3f_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_18b3f_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_18b3f_row0_col0" class="data row0 col0" >N:1</td>
      <td id="T_18b3f_row0_col1" class="data row0 col1" >0</td>
      <td id="T_18b3f_row0_col2" class="data row0 col2" >829</td>
      <td id="T_18b3f_row0_col3" class="data row0 col3" >110,021</td>
      <td id="T_18b3f_row0_col4" class="data row0 col4" >32,951</td>
      <td id="T_18b3f_row0_col5" class="data row0 col5" >110,021</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods</span> <span class="o">=</span> <span class="n">tmp_df_items</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_products</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will create the following metrics for each seller:</p>
<ul class="simple">
<li><p>Total products sold</p></li>
<li><p>Count of unique products sold</p></li>
<li><p>Number of orders</p></li>
<li><p>Total sales value</p></li>
<li><p>Average carrier handoff delay</p></li>
<li><p>Average number of items per order</p></li>
<li><p>Average order value</p></li>
<li><p>Average item price</p></li>
<li><p>Average product weight</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg_1</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tmp_df_items_prods</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">unique_products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">orders_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">revenue</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_carrier_delivery_delay_days</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;carrier_delivery_delay_days&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tmp_df_items_prods</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">products_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">order_total_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_product_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">avg_prouducts_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;products_cnt&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_order_total_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;order_total_price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">avg_product_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;avg_product_price&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Important note for average weight calculation:</p>
<ul class="simple">
<li><p>We must remove duplicates to calculate averages based on unique products only.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg_3</span> <span class="o">=</span> <span class="p">(</span>
     <span class="n">tmp_df_items_prods</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">])</span>
     <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
     <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
          <span class="n">avg_product_weight_kg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;product_weight_g&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
     <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg_3</span><span class="p">[</span><span class="s1">&#39;avg_product_weight_kg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_df_items_prods_agg_3</span><span class="p">[</span><span class="s1">&#39;avg_product_weight_kg&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will merge intermediate dataframes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_items_prods_agg_1</span><span class="p">,</span> <span class="n">tmp_df_items_prods_agg_2</span><span class="p">,</span> <span class="s2">&quot;seller_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_2742a caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_2742a th {
  text-align: left;
}
#T_2742a_row0_col0, #T_2742a_row0_col1, #T_2742a_row0_col2, #T_2742a_row0_col3, #T_2742a_row0_col4, #T_2742a_row0_col5 {
  text-align: left;
}
</style>
<table id="T_2742a">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_2742a_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_2742a_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_2742a_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_2742a_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_2742a_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_2742a_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_2742a_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_2742a_row0_col1" class="data row0 col1" >0</td>
      <td id="T_2742a_row0_col2" class="data row0 col2" >0</td>
      <td id="T_2742a_row0_col3" class="data row0 col3" >2,947</td>
      <td id="T_2742a_row0_col4" class="data row0 col4" >2,947</td>
      <td id="T_2742a_row0_col5" class="data row0 col5" >2,947</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg_1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_items_prods_agg_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">tmp_df_items_prods_agg</span><span class="p">,</span> <span class="n">tmp_df_items_prods_agg_3</span><span class="p">,</span> <span class="s2">&quot;seller_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_d535c caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_d535c th {
  text-align: left;
}
#T_d535c_row0_col0, #T_d535c_row0_col1, #T_d535c_row0_col2, #T_d535c_row0_col3, #T_d535c_row0_col4, #T_d535c_row0_col5 {
  text-align: left;
}
</style>
<table id="T_d535c">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_d535c_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_d535c_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_d535c_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_d535c_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_d535c_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_d535c_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_d535c_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_d535c_row0_col1" class="data row0 col1" >0</td>
      <td id="T_d535c_row0_col2" class="data row0 col2" >0</td>
      <td id="T_d535c_row0_col3" class="data row0 col3" >2,947</td>
      <td id="T_d535c_row0_col4" class="data row0 col4" >2,947</td>
      <td id="T_d535c_row0_col5" class="data row0 col5" >2,947</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_df_items_prods_agg</span> <span class="o">=</span> <span class="n">tmp_df_items_prods_agg</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_items_prods_agg_3</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will add new fields to df_sellers.</p>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_sellers</span><span class="p">,</span> <span class="n">tmp_df_items_prods_agg</span><span class="p">,</span> <span class="s2">&quot;seller_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_ec9ee caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_ec9ee th {
  text-align: left;
}
#T_ec9ee_row0_col0, #T_ec9ee_row0_col1, #T_ec9ee_row0_col2, #T_ec9ee_row0_col3, #T_ec9ee_row0_col4, #T_ec9ee_row0_col5 {
  text-align: left;
}
</style>
<table id="T_ec9ee">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_ec9ee_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_ec9ee_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_ec9ee_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_ec9ee_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_ec9ee_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_ec9ee_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_ec9ee_row0_col0" class="data row0 col0" >1:1</td>
      <td id="T_ec9ee_row0_col1" class="data row0 col1" >148</td>
      <td id="T_ec9ee_row0_col2" class="data row0 col2" >0</td>
      <td id="T_ec9ee_row0_col3" class="data row0 col3" >3,095</td>
      <td id="T_ec9ee_row0_col4" class="data row0 col4" >2,947</td>
      <td id="T_ec9ee_row0_col5" class="data row0 col5" >3,095</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Sellers whose products were never purchased (or whose orders were canceled) will have missing values. This is expected.</p>
<p>Merge tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sellers</span> <span class="o">=</span> <span class="n">df_sellers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_df_items_prods_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;seller_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>From Table  df_geolocations<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Check key mismatches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_sellers</span><span class="p">,</span> <span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;seller_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_ef159 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_ef159 th {
  text-align: left;
}
#T_ef159_row0_col0, #T_ef159_row0_col1, #T_ef159_row0_col2, #T_ef159_row0_col3, #T_ef159_row0_col4, #T_ef159_row0_col5 {
  text-align: left;
}
</style>
<table id="T_ef159">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_ef159_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_ef159_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_ef159_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_ef159_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_ef159_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_ef159_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_ef159_row0_col0" class="data row0 col0" >N:1</td>
      <td id="T_ef159_row0_col1" class="data row0 col1" >7</td>
      <td id="T_ef159_row0_col2" class="data row0 col2" >16,776</td>
      <td id="T_ef159_row0_col3" class="data row0 col3" >3,095</td>
      <td id="T_ef159_row0_col4" class="data row0 col4" >19,015</td>
      <td id="T_ef159_row0_col5" class="data row0 col5" >3,095</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>As previously established, some sellersâ€™ zip prefixes are missing from the geolocation table.</p>
<p>We will check using truncated prefixes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fron</span><span class="o">.</span><span class="n">analyze_join_keys</span><span class="p">(</span><span class="n">df_sellers</span><span class="p">,</span> <span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;seller_zip_code_prefix_3_digits&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix_3_digits&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_6fd07 caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_6fd07 th {
  text-align: left;
}
#T_6fd07_row0_col0, #T_6fd07_row0_col1, #T_6fd07_row0_col2, #T_6fd07_row0_col3, #T_6fd07_row0_col4, #T_6fd07_row0_col5 {
  text-align: left;
}
</style>
<table id="T_6fd07">
  <caption>Join info</caption>
  <thead>
    <tr>
      <th id="T_6fd07_level0_col0" class="col_heading level0 col0" >Type</th>
      <th id="T_6fd07_level0_col1" class="col_heading level0 col1" >Left-only keys</th>
      <th id="T_6fd07_level0_col2" class="col_heading level0 col2" >Right-only keys</th>
      <th id="T_6fd07_level0_col3" class="col_heading level0 col3" >Left size</th>
      <th id="T_6fd07_level0_col4" class="col_heading level0 col4" >Right size</th>
      <th id="T_6fd07_level0_col5" class="col_heading level0 col5" >Left join size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_6fd07_row0_col0" class="data row0 col0" >N:M</td>
      <td id="T_6fd07_row0_col1" class="data row0 col1" >0</td>
      <td id="T_6fd07_row0_col2" class="data row0 col2" >218</td>
      <td id="T_6fd07_row0_col3" class="data row0 col3" >3,095</td>
      <td id="T_6fd07_row0_col4" class="data row0 col4" >19,015</td>
      <td id="T_6fd07_row0_col5" class="data row0 col5" >98,152</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We will handle this the same way as with customers:</p>
<ul class="simple">
<li><p>Keep as-is for geo-analysis (no missing data)</p></li>
<li><p>Maintain precision for distance calculations (accept missing values)</p></li>
<li><p>Use left join to preserve all sellers</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sellers</span> <span class="o">=</span> <span class="n">df_sellers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_geolocations</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;seller_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df_sellers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;geolocation_lat&#39;</span><span class="p">:</span> <span class="s1">&#39;lat_seller&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_lng&#39;</span><span class="p">:</span> <span class="s1">&#39;lng_seller&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sellers</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;geolocation_zip_code_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;geolocation_zip_code_prefix_3_digits&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s look at the missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sellers</span><span class="o">.</span><span class="n">explore</span><span class="o">.</span><span class="n">detect_anomalies</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_636fd caption {
  font-size: 16px;
  text-align: left;
  font-weight: bold;
  white-space: nowrap;
}
#T_636fd th {
  text-align: left;
}
#T_636fd_row0_col0, #T_636fd_row0_col1, #T_636fd_row1_col0, #T_636fd_row1_col1, #T_636fd_row2_col0, #T_636fd_row2_col1, #T_636fd_row3_col0, #T_636fd_row3_col1, #T_636fd_row4_col0, #T_636fd_row4_col1, #T_636fd_row5_col0, #T_636fd_row5_col1, #T_636fd_row6_col0, #T_636fd_row6_col1, #T_636fd_row7_col0, #T_636fd_row7_col1, #T_636fd_row8_col0, #T_636fd_row8_col1, #T_636fd_row9_col0, #T_636fd_row9_col1, #T_636fd_row10_col0, #T_636fd_row10_col1, #T_636fd_row11_col0, #T_636fd_row11_col1 {
  text-align: left;
}
</style>
<table id="T_636fd">
  <caption>Missings by Column</caption>
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_636fd_level0_col0" class="col_heading level0 col0" >Count</th>
      <th id="T_636fd_level0_col1" class="col_heading level0 col1" >Percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_636fd_level0_row0" class="row_heading level0 row0" >products_cnt</th>
      <td id="T_636fd_row0_col0" class="data row0 col0" >148</td>
      <td id="T_636fd_row0_col1" class="data row0 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row1" class="row_heading level0 row1" >unique_products_cnt</th>
      <td id="T_636fd_row1_col0" class="data row1 col0" >148</td>
      <td id="T_636fd_row1_col1" class="data row1 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row2" class="row_heading level0 row2" >orders_cnt</th>
      <td id="T_636fd_row2_col0" class="data row2 col0" >148</td>
      <td id="T_636fd_row2_col1" class="data row2 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row3" class="row_heading level0 row3" >revenue</th>
      <td id="T_636fd_row3_col0" class="data row3 col0" >148</td>
      <td id="T_636fd_row3_col1" class="data row3 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row4" class="row_heading level0 row4" >avg_carrier_delivery_delay_days</th>
      <td id="T_636fd_row4_col0" class="data row4 col0" >149</td>
      <td id="T_636fd_row4_col1" class="data row4 col1" >4.81%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row5" class="row_heading level0 row5" >avg_prouducts_cnt</th>
      <td id="T_636fd_row5_col0" class="data row5 col0" >148</td>
      <td id="T_636fd_row5_col1" class="data row5 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row6" class="row_heading level0 row6" >avg_order_total_price</th>
      <td id="T_636fd_row6_col0" class="data row6 col0" >148</td>
      <td id="T_636fd_row6_col1" class="data row6 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row7" class="row_heading level0 row7" >avg_product_price</th>
      <td id="T_636fd_row7_col0" class="data row7 col0" >148</td>
      <td id="T_636fd_row7_col1" class="data row7 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row8" class="row_heading level0 row8" >avg_product_weight_kg</th>
      <td id="T_636fd_row8_col0" class="data row8 col0" >148</td>
      <td id="T_636fd_row8_col1" class="data row8 col1" >4.78%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row9" class="row_heading level0 row9" >lat_seller</th>
      <td id="T_636fd_row9_col0" class="data row9 col0" >7</td>
      <td id="T_636fd_row9_col1" class="data row9 col1" >0.23%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row10" class="row_heading level0 row10" >lng_seller</th>
      <td id="T_636fd_row10_col0" class="data row10 col0" >7</td>
      <td id="T_636fd_row10_col1" class="data row10 col1" >0.23%</td>
    </tr>
    <tr>
      <th id="T_636fd_level0_row11" class="row_heading level0 row11" >in_south_america</th>
      <td id="T_636fd_row11_col0" class="data row11 col0" >7</td>
      <td id="T_636fd_row11_col1" class="data row11 col1" >0.23%</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We will clear temporary variables from memory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;tmp_&#39;</span><span class="p">):</span>
        <span class="k">del</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="07_converting_data_to_a_convenient_format.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Converting Data to a Convenient Format</p>
      </div>
    </a>
    <a class="right-next"
       href="09_intermediate_conclusion.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Intermediate Conclusion</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-items">Enriching Table df_items</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-orders">Enriching Table df_orders</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-payments">From Table  df_payments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-tables-df-items-and-df-products">From Tables df_items and df_products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-customers">From Table  df_customers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-reviews">From Table  df_reviews</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-new-dimensions">Creating New Dimensions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-table-df-sales">Creating Table df_sales</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-customers">Enriching Table df_customers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-orders">From Table  df_orders</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-sales">From Table  df_sales</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-table-df-geolocations">From Table  df_geolocations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#customer-segmentation">Customer Segmentation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-products">Enriching Table df_products</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">From Table  df_orders</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">From Table  df_sales</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enriching-table-df-sellers">Enriching Table df_sellers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">From Tables df_items and df_products</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">From Table  df_geolocations</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pavel Grigoryev
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2025, Pavel Grigoryev.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>